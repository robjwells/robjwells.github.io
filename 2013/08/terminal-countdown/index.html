<!DOCTYPE html>
<html lang="en">
  <head>
  <title>Primary Unit – Terminal countdown</title>
  
  
<meta charset="utf-8">

<link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Primary Unit" />
<link rel="alternate" type="application/json" href="/feed.json" title="Primary Unit" />

<link rel="mask-icon" href="/favicon.svg" color="#1369BF">
<link rel="apple-touch-icon-precomposed" href="/favicon.png">
<link rel="icon" href="/favicon.ico">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="A blog by Rob Wells, mostly about computer stuff.">

<style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey: #607080;--grey10: #eff0f2;--grey5: #f7f8f9;--blue: #1369bf;--blue10: #e7eff8;--purple: #7436b3;--lineSpace: 1.75rem;--halfLine: calc(var(--lineSpace) / 2);--quarterLine: calc(var(--lineSpace) / 4);--bigGap: calc(var(--lineSpace) * 2);--paragraphWidth: 40rem;--wrapperWidth: 50rem;--huge: 1.75rem;--big: 1.5625rem;--medium: 1.375rem;--text: 1.125rem;--small: 0.875rem;--codeInText: 0.875em;--bodyFonts: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace: 'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article p{max-width:var(--paragraphWidth)}article li{margin-bottom:var(--halfLine);max-width:calc(var(--paragraphWidth) - var(--lineSpace))}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style>
  
  <style>div.highlight>pre.chroma{padding:0;margin:0}:root{--lineNumberGrey: #6D6D6D;--operatorOrange: #B45000;--stringGreen: #357D06}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .ln{margin-right:var(--halfLine);padding:0;color:var(--lineNumberGrey)}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:var(--operatorOrange)}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:var(--stringGreen)}.chroma .sa{color:var(--stringGreen)}.chroma .sb{color:var(--stringGreen)}.chroma .sc{color:var(--stringGreen)}.chroma .dl{color:var(--stringGreen)}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:var(--stringGreen)}.chroma .se{color:var(--stringGreen)}.chroma .sh{color:var(--stringGreen)}.chroma .si{color:var(--stringGreen)}.chroma .sx{color:var(--stringGreen)}.chroma .sr{color:var(--stringGreen)}.chroma .s1{color:var(--stringGreen)}.chroma .ss{color:var(--stringGreen)}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:var(--operatorOrange);font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}</style>

</head>

  <body>
    <div class="wrapper">
      
  <header class="site-header">

    <div class="site-title-container mute-links">
      <h1 class="site-title"><a href="/">Primary Unit</a></h1>
      <p class="site-byline"><i>by</i> Rob Wells</p>
    </div>

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/books/">Books I’ve read</a></li>
        <li>
          Feed:
          <a href="/feed.json">JSON</a>,
          <a href="/rss.xml">RSS</a>
        </li>
      </ul>
    </nav>

  </header> 

      <main>
        
    <article>
      <header>
        <h2 class="mute-links"><a href="/2013/08/terminal-countdown/">Terminal countdown</a></h2>
        
        <p><time datetime='2013-08-17T14:36:00&#43;0000'>Saturday, August 17 2013</time></p>
        
      </header>
      <p>I’ve got some annual leave booked for the very end of September, which is pretty far away still — but I wanted to know exactly how many days I have to go before my break.</p>
<p>Usually I would just query <a href="http://www.wolframalpha.com/input/?i=Days+until+December+25+2013">Wolfram Alpha</a> but, since I’ve been spending a fair amount of time at the command line, I wondered if <code>date</code> in Unix could give me the answer.</p>
<p>It’s easy to ask <code>date</code> to add or subtract an amount of time:</p>
<pre><code>$ date -v +2w   # Now plus two weeks
Sat 31 Aug 2013 13:14:20 BST
</code></pre>
<p>However there’s no built-in way to find the difference between two dates. So I wrote one. Now originally I was going to walk through that shell script but there were enough problems that I rewrote it in Python this morning.</p>
<p>But before I get to the Python code I want to discuss the shell script.</p>
<p>It took a date in <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO format</a> (<a href="http://www.xkcd.com/1179/">because</a>) and ran it through <code>date</code> to get back a <a href="http://en.wikipedia.org/wiki/Unix_time">Unix timestamp</a>. This was then subtracted from the timestamp for the current date and divided by the number of seconds in a day to give the number of days difference.</p>
<p>Unfortunately writing the script gave me a few headaches:</p>
<ul>
<li>Unix timestamps can break.
Passing a date before 1902 caused <code>date</code> to choke on my machine, and this varies from system to system.</li>
<li>Commands you expect to be reliable can differ wildly between systems.
I used <code>egrep</code> to check the format of the provided date and used <code>\d</code> as the digit wildcard. But on my work machine, which runs Mac OS 10.6, you can only use <code>\d</code> with <code>grep -P</code>. That breaks <code>grep</code> on 10.8 at home.
The nasty solution was to use an explicit range: <code>[0-9]</code>. Gross.</li>
<li>The bash scripting syntax is insane.
Want to check if stdin is connected to an interactive terminal, so you know you won’t be getting data on stdin? Use <code>-t 0</code>.
Meanwhile in Python: <code>sys.stdin.isatty()</code>.</li>
</ul>
<p>The timestamp problem is an edge case as days aren’t a useful measure of time past a certain, short distance, so it was mainly the reliability and syntax complaints that pushed me to rewrite the script. I don’t consider <code>\d</code> to be exotic and with the removal of the <code>-P</code> option in newer versions of <code>grep</code> how can you expect to use it in portable code?</p>
<p>As for the syntax, while I was pleased I’d managed to lump together enough parts to make a working program, it’s not clear by any means — and this is just a 45-line wrapper around <code>date</code>! String comparisons in bash get to use <code>!=</code> and <code>==</code> but numbers are stuck with <code>-ne</code> and <code>-eq</code>? Oh god it’s <em>horrible</em>.</p>
<p>Anyway, let’s move on to the Python script:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="ch">#!/usr/bin/env python3</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="ln"> 4</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="ln"> 5</span><span class="kn">import</span> <span class="nn">os</span>
<span class="ln"> 6</span><span class="kn">import</span> <span class="nn">re</span>
<span class="ln"> 7</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<span class="ln">10</span>  <span class="n">date</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="ln">11</span><span class="k">elif</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
<span class="ln">12</span>  <span class="c1"># Called in a pipeline</span>
<span class="ln">13</span>  <span class="n">date</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="ln">14</span><span class="k">else</span><span class="p">:</span>
<span class="ln">15</span>  <span class="c1"># Print usage message if no date is supplied</span>
<span class="ln">16</span>  <span class="n">script</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="ln">17</span>  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Usage:  {0} YYYY-MM-DD</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="ln">18</span>        <span class="s1">&#39;        prints number of days until or since the given date&#39;</span>
<span class="ln">19</span>        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>
<span class="ln">20</span>  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="ln">21</span>
<span class="ln">22</span><span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d{4}-\d{2}-\d{2}&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="ln">23</span>  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Abort:  your date is not in YYYY-MM-DD format&#39;</span><span class="p">)</span>
<span class="ln">24</span>  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>
<span class="ln">25</span><span class="k">else</span><span class="p">:</span>
<span class="ln">26</span>  <span class="n">then</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="ln">27</span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="ln">28</span><span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="n">then</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="k">if</span> <span class="n">days</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">31</span>  <span class="k">print</span><span class="p">(</span><span class="s2">&#34;That&#39;s today!&#34;</span><span class="p">)</span>
<span class="ln">32</span>  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="ln">33</span>
<span class="ln">34</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; day&#39;</span>
<span class="ln">35</span><span class="k">if</span> <span class="n">days</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<span class="ln">36</span>  <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;s&#39;</span>
<span class="ln">37</span>
<span class="ln">38</span><span class="k">if</span> <span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="ln">39</span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ago&#39;</span>
<span class="ln">40</span><span class="k">else</span><span class="p">:</span>
<span class="ln">41</span>  <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; ahead&#39;</span>
<span class="ln">42</span><span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div><p>It works in much the same way as the shell script. (In case anyone’s wondering, the <code>print_function</code> import is for Python 2 compatibility — just change the shebang line to plain <code>python</code>.)</p>
<p>Lines 9–13 handle input from an argument or stdin, and a usage message is printed (lines 14–20) if nothing is passed.</p>
<p>Next is the regular expression to check the date’s format (using <code>\d</code>! Yes!).
A warning is printed and the script exits if it doesn’t match, otherwise a datetime object is created using a <code>strptime</code> format string in the same way you would with <code>date</code> at the terminal. <code>date()</code> is immediately called on the object (line 26) because we want to work with full days only.</p>
<p>One nice thing about Python’s datetime module is timedelta, which lets you subtract one date from another and returns the difference — we do that in line 28 and extract the <code>days</code> attribute.</p>
<p>From here we’re just constructing the message printed to the user, with a check for the current date and then whether “days” should be plural. If the date is in the past we trim the minus sign in line 39, then stick on an appropriate adverb and print.</p>
<p>All told, we end up with this:</p>
<pre><code>$ days 2013-12-25
130 days ahead
$ days 2013-01-01
228 days ago
</code></pre>
<p>I’ve posted both the <a href="https://gist.github.com/robjwells/6256540">Python and shell versions as a gist</a> if you’d like to compare the two.</p>

    </article>
    

      </main>
      <footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> 

    </div> 
  </body>
</html>
