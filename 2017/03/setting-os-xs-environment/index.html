<!doctype html><html lang=en>
<head>
<title>Primary Unit – Setting OS X’s environment</title>
<meta charset=utf-8>
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; block-all-mixed-content; base-uri 'self'">
<link rel=license href=https://creativecommons.org/licenses/by/4.0/>
<link rel=alternate type=application/rss+xml href=/rss.xml title="Primary Unit">
<link rel=alternate type=application/json href=/feed.json title="Primary Unit">
<link rel=mask-icon href=/favicon.svg color=#1369bf>
<link rel=apple-touch-icon-precomposed href=/favicon.png>
<link rel=icon href=/favicon.ico>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="A blog by Rob Wells, mostly about computer stuff.">
<style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey:#607080;--grey10:#eff0f2;--grey5:#f7f8f9;--blue:#1369bf;--blue10:#e7eff8;--purple:#7436b3;--lineSpace:1.75rem;--halfLine:calc(var(--lineSpace) / 2);--quarterLine:calc(var(--lineSpace) / 4);--bigGap:calc(var(--lineSpace) * 2);--paragraphWidth:40rem;--wrapperWidth:50rem;--huge:1.75rem;--big:1.5625rem;--medium:1.375rem;--text:1.125rem;--small:0.875rem;--codeInText:0.875em;--bodyFonts:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace:'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article li{margin-bottom:var(--halfLine)}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style>
</head>
<body>
<div class=wrapper>
<header class=site-header>
<div class="site-title-container mute-links">
<h1 class=site-title><a href=/>Primary Unit</a></h1>
<p class=site-byline><i>by</i> Rob Wells</p>
</div>
<nav id=site-nav>
<ul class="site-links mute-links">
<li><a href=/about/>About</a></li>
<li><a href=/books/>Books I’ve read</a></li>
<li>
Feed:
<a href=/feed.json>JSON</a>,
<a href=/rss.xml>RSS</a>
</li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h2 class=mute-links><a href=/2017/03/setting-os-xs-environment/>Setting OS X’s environment</a></h2>
<p><time datetime=2017-03-02T14:30:00+0000>Thursday, March 2 2017</time></p>
</header>
<div class=flag>
<p><strong>Warning: The contents of this post may not be up to date!</strong></p>
<p>Sorry, but if you’re searching for answers about why you can’t reliably set environment variables in OS X (particularly <code>PATH</code>), the information below may be out of date.</p>
<p>Apple has changed the system so many times in so many different ways it’s difficult to find <em>anything</em> on the internet about this that is correct and up-to-date, so I’ve placed this warning on the top of every post I’ve written about it.</p>
<p>As of 2017-03-02 it appears that the best collection of information is <a href=https://github.com/ersiner/osx-env-sync>the osx-env-sync project on GitHub</a> and its associated issues.</p>
<p>Be wary of anything that you find on StackOverflow: the answers there may well have been correct at the time but incorrect now.</p>
<p>For reference, my own posts on this problem (newest first) are:</p>
<ul>
<li><a href=/2017/03/setting-os-xs-environment/>Setting OS X’s environment</a></li>
<li><a href=/2014/12/locale-in-os-x-whats-the-current-situation/>Locale in OS X — what’s the current situation?</a></li>
<li><a href=/2014/12/locale-in-os-x-and-launch-agents/>Locale in OS X and Launch Agents</a></li>
<li><a href=/2013/09/get-your-us-ascii-out-of-my-face/>Get your US-ASCII out of my face</a></li>
</ul>
</div>
<p>Trying to set a consistent environment in OS X is the single most frustrating thing I’ve ever tried to do on a Mac.</p>
<p>I’ve written three posts (<a href=/2013/09/get-your-us-ascii-out-of-my-face/>1</a>, <a href=/2014/12/locale-in-os-x-and-launch-agents/>2</a>, <a href=/2014/12/locale-in-os-x-whats-the-current-situation/>3</a>) in the past few years trying to get to the bottom of this but <em>still</em> I have problems. (That’s why that giant disclaimer is on the top of this post!)</p>
<p>This bit me again the other day when using a Jupyter notebook to <a href=/2017/03/textexpander-to-launchbar-snippets/>export from TextExpander</a>, with my favourite UnicodeDecodeError. Here’s an example:</p>
<pre><code>-----------------------------------------------------------------
UnicodeEncodeError              Traceback (most recent call last)
&lt;ipython-input-8-c4b3c1d6f2e6&gt; in &lt;module&gt;()
      1 with open('/Users/robjwells/Desktop/testfile', 'w') as f:
----&gt; 2     f.write('☃')

UnicodeEncodeError: 'ascii' codec can't encode character
'\u2603' in position 0: ordinal not in range(128)
</code></pre>
<p>Now, this machine has been upgraded all the way from 10.7 and my understanding is that if you’ve a fresh install of a more recent version then you should be OK as far as the encoding-related environment variables (<code>LANG</code>, <code>LC_CTYPE</code>, <code>LC_ALL</code>). <a href=https://www.python.org/dev/peps/pep-0538/#background>A recent Python enhancement proposal</a> includes the paragraph:</p>
<blockquote>
<p>On Apple platforms (including both Mac OS X and iOS), this [ensuring Python is set to use UTF-8] is straightforward, as Apple guarantees that these [Python start-up] operations will always use UTF-8 to do the conversion.</p>
</blockquote>
<p>If you’ve ready my posts linked above, particularly <a href=/2014/12/locale-in-os-x-and-launch-agents/>Locale in OS X and Launch Agents</a>, a good question arises: “I thought you’d figured this out!”</p>
<p>Well, yeah, me too! I have a script that runs at start-up designed to set my environment up. But it’s not reliable — I think because it may run after other start-up items (both Launch Agents & Daemons, and the Login Items listed in System Preferences). One of those is my Jupyter notebook server, hence the problem above.</p>
<p>Having the environment script run as the root user doesn’t solve the problem — in fact it means it has no effect at all.</p>
<p>(My way of checking whether a program has inherited my script-set environment variables is to define <code>RJWENVSET</code> as well.)</p>
<p>And then there’s the <code>PATH</code>, which I used to set in the same script using <code>launchctl setenv</code> like my other environment variables. Which doesn’t work. There’s a suggestion on <a href=https://github.com/ersiner/osx-env-sync/issues/1#issuecomment-230053839>a GitHub issue for a tool meant to resolve this problem</a> that the following command could reliably set the path:</p>
<pre><code>sudo launchctl config user path $PATH
</code></pre>
<p>But that doesn’t work for me. You can swap <code>user</code> for <code>system</code> but I’m wary of doing that.</p>
<p>This problem is ludicrously frustrating. Apple deprecated /etc/launchd.conf “for security considerations” but it means there’s no reliable way of setting variables that will be inherited by your programs, and so no way of having a consistent environment.</p>
<p>What a pain in the arse.</p>
<p>Right now, I’m doing the following:</p>
<ul>
<li>I have my environment.sh file set <code>LANG</code>, <code>LC_ALL</code>, <code>LC_CTYPE</code>, <code>PYTHONPATH</code>, <code>RJWENVSET</code> when it is run at start-up by <a href=https://www.peterborgapps.com/lingon/>Lingon</a> (for “all users”, though I’m not sure if this is any more effective than using “me” — I’m the only user on this machine).</li>
<li>My Lingon start-up items have environment variables and their <code>PATH</code> set explicitly.</li>
<li>I currently restart other start-up items that don’t pick up the variables set by environment.sh — but that doesn’t solve the <code>PATH</code> problem so you’ll want to <a href=http://leancrew.com/all-this/2017/03/the-keyboard-maestro-scripting-environment/>set that explicitly</a>.</li>
</ul>
<p>But for Pete’s sake I wish I could just define variables in ~/.launchd.conf and be done with it.</p>
</article>
</main>
<footer class=site-footer>
<small class=mute-links>
This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>
Creative Commons Attribution 4.0 International License</a>.
</small>
</footer>
</div>
</body>
</html>