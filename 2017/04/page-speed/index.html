<!doctype html><html lang=en><head><title>Primary Unit – Page speed</title><meta charset=utf-8><meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; block-all-mixed-content; base-uri 'self'"><link rel=license href=https://creativecommons.org/licenses/by/4.0/><link rel=alternate type=application/rss+xml href=/rss.xml title="Primary Unit"><link rel=alternate type=application/json href=/feed.json title="Primary Unit"><link rel=mask-icon href=/favicon.svg color=#1369bf><link rel=apple-touch-icon-precomposed href=/favicon.png><link rel=icon href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A blog by Rob Wells, mostly about computer stuff."><style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey: #607080;--grey10: #eff0f2;--grey5: #f7f8f9;--blue: #1369bf;--blue10: #e7eff8;--purple: #7436b3;--lineSpace: 1.75rem;--halfLine: calc(var(--lineSpace) / 2);--quarterLine: calc(var(--lineSpace) / 4);--bigGap: calc(var(--lineSpace) * 2);--paragraphWidth: 40rem;--wrapperWidth: 50rem;--huge: 1.75rem;--big: 1.5625rem;--medium: 1.375rem;--text: 1.125rem;--small: 0.875rem;--codeInText: 0.875em;--bodyFonts: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace: 'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article p{max-width:var(--paragraphWidth)}article li{margin-bottom:var(--halfLine);max-width:calc(var(--paragraphWidth) - var(--lineSpace))}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style></head><body><div class=wrapper><header class=site-header><div class="site-title-container mute-links"><h1 class=site-title><a href=/>Primary Unit</a></h1><p class=site-byline><i>by</i> Rob Wells</p></div><nav id=site-nav><ul class="site-links mute-links"><li><a href=/about/>About</a></li><li><a href=/books/>Books I’ve read</a></li><li>Feed:
<a href=/feed.json>JSON</a>,
<a href=/rss.xml>RSS</a></li></ul></nav></header><main><article><header><h2 class=mute-links><a href=/2017/04/page-speed/>Page speed</a></h2><p><time datetime=2017-04-10T10:40:00+0000>Monday, April 10 2017</time></p></header><p>Since I moved the blog off Tumblr, I’ve tried to make it reasonably quick. Reasonably because it’s come in waves — waves of me saying: “Oh, that’s fine” and then deciding that whatever it is isn’t fine and needs to go.</p><p>Tumblr used to whack in about 1MB of extra guff for its own purposes. If you’re posting endless gifs then that’s not something you’ll notice, but when you’re mostly dealing in text it’s pretty obvious.</p><p>When I <a href=/2013/07/five-different-kinds-of-grey/>redesigned the site</a> almost four years ago I remember chafing at this, but it wasn’t until I settled on <a href=https://github.com/robjwells/majestic/>my own site generator</a> that I had the chance to really whittle things down.</p><p>Much of that was lopping off unneeded stuff such as jQuery. It did succeed in getting the size down — to about 150–200kB for an average post. But I’ve recently made a few changes to speed things up that I wanted to talk about.</p><p>Much of this has come about after reading Jacques Mattheij’s <a href=https://jacquesmattheij.com/the-fastest-blog-in-the-world>The Fastest Blog in the World</a> and Dan Luu’s two excellent posts <a href=https://danluu.com/octopress-speedup/>Speeding up this blog by 25x-50x</a> and <a href=https://danluu.com/web-bloat/>Most of the web really sucks if you have a slow connection</a>. (And, well, of course, <a href=http://idlewords.com/talks/website_obesity.htm>Maciej</a>. You should really read that one.)</p><h3 id=fonts>Fonts</h3><p>For ages this site used <a href=https://typekit.com/fonts/rooney>Rooney</a> served by Typekit as its main font. I <em>love</em> Rooney, it’s great. But using web fonts always means sending lots of data.</p><p>Despite thinning down the included characters (Typekit allows you to choose language support) and forgoing the use of double emphasis (<code>&lt;em>&lt;strong></code>), serving up three weights of Rooney still clocked in at over 100kB.</p><p>I’m looking at Rooney now and it is gorgeous, but there’s no way I could or can justify it — the fonts collectively would usually outweigh anything else on a page. So it went, in favour of Trebuchet MS, which I’ve long had a soft spot for.</p><h3 id=dns>DNS</h3><p>Not related to the bytes served up but switching my registrar’s (<a href=https://www.hover.com>Hover</a>’s) name servers for <a href=https://www.cloudflare.com>Cloudflare</a> helped cut about 100ms in DNS response times (from about 150ms).</p><p>You can host your DNS with Cloudflare for free without using any of their other caching services (I don’t), and Cloudflare is consistently <a href=http://www.dnsperf.com>one of the fastest DNS hosts in the world</a>.</p><h3 id=syntax-highlighting>Syntax highlighting</h3><p>Up until now I’d been using <a href=https://highlightjs.org>highlighting.js</a> to colour code snippets, and I’d been very happy with it. It’s a nice library that’s easy to work with and easy to download a customised version for your own use.</p><p>But I’d been handing out a 10kB JavaScript library to everyone who visited — whether there was code to be highlighted or not. Had I included more than a handful of languages in my library it would have been even more.</p><p>My first decision was to use my <a href=https://github.com/robjwells/majestic/>blog generator</a>’s extensions mechanism to mark every post or page that included code and would need highlighting — so if you visited a page without code, you didn’t receive the JavaScript library.</p><p>But really that wasn’t enough for me. A few things annoyed me:</p><ul><li>Syntax highlighting had to be performed on every view on the client device at readers’ expense.</li><li>I could only highlight those languages I’d included in my library.</li><li>The library included all of my selected languages no matter what was on the page.</li></ul><p>This wasn’t ideal.</p><p>The <a href=https://pythonhosted.org/Markdown/>Markdown module</a> I use has support for syntax highlighting, but there were <a href=http://www.leancrew.com/all-this/2010/12/new-syntax-highlighting-for-markdown/>some deficiencies</a> with it that had led me to pick the client-side highlighter in the first place, several years ago.</p><p>It wasn’t difficult to fix that, however. Taking inspiration from <a href=https://alexwlchan.net/2017/03/extensions-in-python-markdown/>Alex Chan</a>, I modified the included Codehilite extension to match my requirements, which were to handle a “natural-looking” language line and line numbers in the Markdown source. You can <a href=https://github.com/robjwells/primaryunit/blob/master/extensions/rjw_highlight.py>see the source online</a>, but it’s pretty rough and I need to tidy it up. (It also uses Pygments’s inline line numbers, instead of the table approach which I’ve seen out of alignment on occasion.)</p><p>The tradeoff here was serving a slightly inflated HTML file but a much-reduced JavaScript file (I kept a <a href=https://github.com/robjwells/primaryunit/blob/master/frontend/js/robjwells.js>barebones script</a> of a tenth of the size to show the plain source) — but the increase in HTML size is much smaller than the original JavaScript was.</p><p>In all, I’ve gone from a baseline of roughly 160kB to 10-15kB per image-free post. It’s not <a href=https://jacquesmattheij.com/the-fastest-blog-in-the-world>the fastest blog in the world</a>, especially if you’re far away from Linode’s London datacentre, but it should be pretty nippy.</p><h3 id=what-else>What else?</h3><p>There are some things which I’ve rejected so far.</p><ul><li><p>Inlining JavaScript and CSS.</p><p>This could make the page render faster, at the expense of transferring data that would otherwise be cached when viewing other pages. (But, assuming the blog is like most others, most will only visit a single page.)</p><p>But I feel a bit icky about munging separate resources together, and in mitigation the site is served over HTTP/2 (<a href="http://caniuse.com/#feat=http2">which most of the world supports</a>) and <a href=https://blog.cloudflare.com/http-2-for-web-developers/>inlining is an anti-pattern</a>.</p></li><li><p>Sack off the traditional front page.</p><p>Yeah, I felt this one acutely recently after posting all those dodgy but massive <a href=/2017/03/tube-crowding/>Tube heat maps</a>, sitting towards the bottom of the front page and inflating its size.</p><p><a href=https://danluu.com>Dan Luu</a> has his archives as the front page, which is svelte but extreme for my tastes. We’ll see about this one.</p></li><li><p>Ditch your CSS.</p><p><a href=http://motherfuckingwebsite.com>Yeah, I know</a>. (<a href=http://bettermotherfuckingwebsite.com>Well</a>.) But I like pretty things. And it’s only about 2.5kB.</p></li></ul></article></main><footer class=site-footer><small class=mute-links>This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>.</small></footer></div></body></html>