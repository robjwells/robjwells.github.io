<!doctype html><html lang=en><head><title>Primary Unit – Redundant publishing</title><meta charset=utf-8><meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; block-all-mixed-content; base-uri 'self'"><link rel=license href=https://creativecommons.org/licenses/by/4.0/><link rel=alternate type=application/rss+xml href=/rss.xml title="Primary Unit"><link rel=alternate type=application/json href=/feed.json title="Primary Unit"><link rel=mask-icon href=/favicon.svg color=#1369bf><link rel=apple-touch-icon-precomposed href=/favicon.png><link rel=icon href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A blog by Rob Wells, mostly about computer stuff."><style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey: #607080;--grey10: #eff0f2;--grey5: #f7f8f9;--blue: #1369bf;--blue10: #e7eff8;--purple: #7436b3;--lineSpace: 1.75rem;--halfLine: calc(var(--lineSpace) / 2);--quarterLine: calc(var(--lineSpace) / 4);--bigGap: calc(var(--lineSpace) * 2);--paragraphWidth: 40rem;--wrapperWidth: 50rem;--huge: 1.75rem;--big: 1.5625rem;--medium: 1.375rem;--text: 1.125rem;--small: 0.875rem;--codeInText: 0.875em;--bodyFonts: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace: 'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article p{max-width:var(--paragraphWidth)}article li{margin-bottom:var(--halfLine);max-width:calc(var(--paragraphWidth) - var(--lineSpace))}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style><style>div.highlight>pre.chroma{padding:0;margin:0}:root{--lineNumberGrey: #6D6D6D;--operatorOrange: #B45000;--stringGreen: #357D06}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .ln{margin-right:var(--halfLine);padding:0;color:var(--lineNumberGrey)}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:var(--operatorOrange)}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:var(--stringGreen)}.chroma .sa{color:var(--stringGreen)}.chroma .sb{color:var(--stringGreen)}.chroma .sc{color:var(--stringGreen)}.chroma .dl{color:var(--stringGreen)}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:var(--stringGreen)}.chroma .se{color:var(--stringGreen)}.chroma .sh{color:var(--stringGreen)}.chroma .si{color:var(--stringGreen)}.chroma .sx{color:var(--stringGreen)}.chroma .sr{color:var(--stringGreen)}.chroma .s1{color:var(--stringGreen)}.chroma .ss{color:var(--stringGreen)}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:var(--operatorOrange);font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}</style></head><body><div class=wrapper><header class=site-header><div class="site-title-container mute-links"><h1 class=site-title><a href=/>Primary Unit</a></h1><p class=site-byline><i>by</i> Rob Wells</p></div><nav id=site-nav><ul class="site-links mute-links"><li><a href=/about/>About</a></li><li><a href=/books/>Books I’ve read</a></li><li>Feed:
<a href=/feed.json>JSON</a>,
<a href=/rss.xml>RSS</a></li></ul></nav></header><main><article><header><h2 class=mute-links><a href=/2017/04/redundant-publishing/>Redundant publishing</a></h2><p><time datetime=2017-04-16T22:39:00+0000>Sunday, April 16 2017</time></p></header><p>In my previous post about <a href=/2017/04/page-speed/>page speed</a>, I mentioned that I’d written <a href=https://github.com/robjwells/majestic>my own site generator</a>. I’m not quite ready to talk specifically about it — I want to write some documentation first — and really I doubt that anyone but me <em>should</em> be using it.</p><p>But, having set up <a href=https://s3.robjwells.com>publishing to Amazon S3</a> today, I wanted to write up how I publish this blog to multiple places so that it’ll be around whatever (within reason) might happen.</p><p><a href=https://github.com/robjwells/majestic>Majestic</a>’s configuration files are set up in such a way that you have have a default settings file in a directory — <code>settings.json</code> — and you can specify others that make adjustments to that.</p><p>In my case the main settings file contains the configuration for publishing to my own server (hosted at Linode) — not the nitty gritty of how to get it on to the server, but what the URLs, site title, etc should be. (It’s online if you want to <a href=https://github.com/robjwells/primaryunit/blob/master/settings.json>have a nose around</a>.)</p><p>Then I have two extra JSON files: <code>robjwells.github.io.json</code> and <code>s3.robjwells.com.json</code>, which contain the customisations for publishing for those domains. Here’s the config for GitHub in full:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;site&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://robjwells.github.io&#34;</span><span class=p>,</span>
    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Primary Unit mirror on GitHub&#34;</span><span class=p>,</span>
    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;A mirror of https://www.robjwells.com hosted on GitHub&#34;</span>
  <span class=p>},</span>

  <span class=nt>&#34;paths&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;output root&#34;</span><span class=p>:</span> <span class=s2>&#34;gh-pages&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Setting <code>site.url</code> is important because of the way my templates render article links (though my markdown source contains only relative links that work anywhere). And <code>paths.output root</code> just specifies the build directory where the HTML files get written.</p><p>All the moving parts are contained in <a href=https://github.com/robjwells/primaryunit/blob/master/makefile>a makefile</a> which can build all three of my destinations. Here it is in full:</p><div class=highlight><pre class=chroma><code class=language-makefile data-lang=makefile><span class=nv>NOW</span> <span class=o>=</span> <span class=k>$(</span>shell date +<span class=s1>&#39;%Y-%m-%d %H:%M&#39;</span><span class=k>)</span>
<span class=nv>DISTID</span> <span class=o>=</span> <span class=k>$(</span>shell cat cloudfront-distribution-id<span class=k>)</span>


<span class=err>define</span> <span class=err>upload-robjwells</span>
<span class=err>rsync</span> <span class=err>-zv</span> <span class=err>-e</span> <span class=err>ssh</span> <span class=err>www.robjwells.com.conf</span>
    <span class=nf>rick@deckard</span><span class=o>:</span>/<span class=n>srv</span>/<span class=n>www</span>/<span class=n>www</span>.<span class=n>robjwells</span>.<span class=n>com</span>/
<span class=err>rsync</span> <span class=err>-azv</span> <span class=err>--delete</span> <span class=err>-e</span> <span class=err>ssh</span> <span class=err>site/</span>
    <span class=nf>rick@deckard</span><span class=o>:</span>/<span class=n>srv</span>/<span class=n>www</span>/<span class=n>www</span>.<span class=n>robjwells</span>.<span class=n>com</span>/<span class=n>html</span>/
<span class=err>endef</span>


<span class=err>define</span> <span class=err>upload-github</span>
<span class=err>cd</span> <span class=err>gh-pages</span> <span class=err>;</span> <span class=err>git</span> <span class=err>add</span> <span class=err>.</span> <span class=err>;</span> <span class=err>git</span> <span class=err>commit</span> <span class=err>-m</span> <span class=s2>&#34;$(NOW)&#34;</span> <span class=err>;</span> <span class=err>git</span> <span class=err>push</span>
<span class=err>endef</span>


<span class=err>define</span> <span class=err>upload-aws</span>
<span class=nf>aws s3 sync s3 s3</span><span class=o>:</span>//<span class=n>s</span>3.<span class=n>robjwells</span>.<span class=n>com</span> --<span class=n>delete</span>
<span class=err>aws</span> <span class=err>cloudfront</span> <span class=err>create-invalidation</span>
    <span class=nv>--distribution-id</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>DISTID<span class=k>)</span><span class=s2>&#34;</span> --paths<span class=o>=</span>/index.html
<span class=err>endef</span>


<span class=nf>all</span><span class=o>:</span> <span class=n>robjwells</span> <span class=n>github</span> <span class=n>aws</span>

<span class=nf>force-all</span><span class=o>:</span> <span class=n>force</span>-<span class=n>robjwells</span> <span class=n>force</span>-<span class=n>github</span> <span class=n>force</span>-<span class=n>aws</span>

<span class=nf>robjwells</span><span class=o>:</span>
  majestic
  <span class=k>$(</span>upload-robjwells<span class=k>)</span>

<span class=nf>force-robjwells</span><span class=o>:</span>
  majestic --force-write
  <span class=k>$(</span>upload-robjwells<span class=k>)</span>

<span class=nf>github</span><span class=o>:</span>
  majestic --settings<span class=o>=</span>robjwells.github.io.json
  <span class=k>$(</span>upload-github<span class=k>)</span>

<span class=nf>force-github</span><span class=o>:</span>
  majestic --settings<span class=o>=</span>robjwells.github.io.json --force-write
  <span class=k>$(</span>upload-github<span class=k>)</span>

<span class=nf>aws</span><span class=o>:</span>
  majestic --settings<span class=o>=</span>s3.robjwells.com.json
  <span class=k>$(</span>upload-aws<span class=k>)</span>

<span class=nf>force-aws</span><span class=o>:</span>
  majestic --settings<span class=o>=</span>s3.robjwells.com.json --force-write
  <span class=k>$(</span>upload-aws<span class=k>)</span>
</code></pre></div><p>(The <code>force-*</code> options rebuild the whole site, not just files which have changed.)</p><p>And, really, that’s all it takes to publish to multiple hosts (once you’re set up at each one, of course).</p><p>My own server is just a vanilla rsync command, with an extra one because I keep my Nginx server config locally too.</p><p>For GitHub pages the <code>gh-pages</code> folder is a git repository, so <code>make github</code> regenerates the site into that folder, commits the changes with a timestamp as the message, and pushes the changes to GitHub. (It’s all on the same line with semicolons because the <code>cd</code> into the directory doesn’t hold across lines in the makefile.) Because the GitHub repository is set up to publish, the rest is sorted out on their end.</p><p>And for S3 I just use the official AWS tool (<code>brew install awscli</code> if you’re on macOS) — the CloudFront line is because I use it to speed up the S3 version and I want to make sure an updated front page is available reasonably quickly, if not anything else.</p><p>There’s a bit of overhead setting all of these up but once you do it doesn’t have to be any more work to keep each host updated. For me it’s just a <code>make all</code> away.</p></article></main><footer class=site-footer><small class=mute-links>This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>.</small></footer></div></body></html>