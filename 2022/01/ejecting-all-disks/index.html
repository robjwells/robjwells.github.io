<!doctype html><html lang=en>
<head>
<title>Primary Unit – Ejecting all disks</title>
<meta charset=utf-8>
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; block-all-mixed-content; base-uri 'self'">
<link rel=license href=https://creativecommons.org/licenses/by/4.0/>
<link rel=alternate type=application/rss+xml href=/rss.xml title="Primary Unit">
<link rel=alternate type=application/json href=/feed.json title="Primary Unit">
<link rel=mask-icon href=/favicon.svg color=#1369bf>
<link rel=apple-touch-icon-precomposed href=/favicon.png>
<link rel=icon href=/favicon.ico>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="A blog by Rob Wells, mostly about computer stuff.">
<style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey:#607080;--grey10:#eff0f2;--grey5:#f7f8f9;--blue:#1369bf;--blue10:#e7eff8;--purple:#7436b3;--lineSpace:1.75rem;--halfLine:calc(var(--lineSpace) / 2);--quarterLine:calc(var(--lineSpace) / 4);--bigGap:calc(var(--lineSpace) * 2);--paragraphWidth:40rem;--wrapperWidth:50rem;--huge:1.75rem;--big:1.5625rem;--medium:1.375rem;--text:1.125rem;--small:0.875rem;--codeInText:0.875em;--bodyFonts:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace:'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article li{margin-bottom:var(--halfLine)}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style>
<style>div.highlight>pre.chroma{padding:0;margin:0}:root{--lineNumberGrey:#6D6D6D;--operatorOrange:#B45000;--stringGreen:#357D06}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .ln{margin-right:var(--halfLine);padding:0;color:var(--lineNumberGrey)}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:var(--operatorOrange)}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:var(--stringGreen)}.chroma .sa{color:var(--stringGreen)}.chroma .sb{color:var(--stringGreen)}.chroma .sc{color:var(--stringGreen)}.chroma .dl{color:var(--stringGreen)}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:var(--stringGreen)}.chroma .se{color:var(--stringGreen)}.chroma .sh{color:var(--stringGreen)}.chroma .si{color:var(--stringGreen)}.chroma .sx{color:var(--stringGreen)}.chroma .sr{color:var(--stringGreen)}.chroma .s1{color:var(--stringGreen)}.chroma .ss{color:var(--stringGreen)}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:var(--operatorOrange);font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}</style>
</head>
<body>
<div class=wrapper>
<header class=site-header>
<div class="site-title-container mute-links">
<h1 class=site-title><a href=/>Primary Unit</a></h1>
<p class=site-byline><i>by</i> Rob Wells</p>
</div>
<nav id=site-nav>
<ul class="site-links mute-links">
<li><a href=/about/>About</a></li>
<li><a href=/books/>Books I’ve read</a></li>
<li>
Feed:
<a href=/feed.json>JSON</a>,
<a href=/rss.xml>RSS</a>
</li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h2 class=mute-links><a href=/2022/01/ejecting-all-disks/>Ejecting all disks</a></h2>
<p><time datetime=2022-01-09T20:48:27+0000>Sunday, January 9 2022</time></p>
</header>
<p>David Sparks posted this week about <a href=https://www.macsparky.com/blog/2022/01/using-keyboard-maestro-and-applescript-to-eject-external-drives/>ejecting disks using AppleScript
and Keyboard Maestro</a>. I’m grateful to David for posting
about this — it’s something I’ve needed for a while but hadn’t got
around to doing. Currently I plug my laptop into several external drives
when I’m sat at my desk, and have to eject them before taking it
somewhere more relaxed.</p>
<p>But David’s script didn’t quite work for me in that a blunt <code>eject the disks</code> command to the Finder will attempt to eject all the disks that
are considered “ejectable”. For me, this includes APFS snapshots that
aren’t obviously visible in the user interface, where trying to eject
them pops up a dialog referencing &ldquo;Macintosh HD – Data@snap…&rdquo;.</p>
<p>My alternative is to filter out any drives that contain &ldquo;Macintosh HD&rdquo;
in their displayed name:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-applescript data-lang=applescript><span class=k>tell</span> <span class=nb>application</span> <span class=s2>&#34;Finder&#34;</span>
    <span class=nv>eject</span> <span class=p>(</span><span class=nb>every</span> <span class=nv>disk</span> <span class=nb>where</span> <span class=s2>&#34;Macintosh HD&#34;</span> <span class=ow>is not</span> <span class=k>in</span> <span class=k>its</span> <span class=nv>displayed</span> <span class=na>name</span><span class=p>)</span>
<span class=k>end</span> <span class=k>tell</span>
</code></pre></div><p>Note that it’s important to use the <em>displayed name</em> property as the
APFS snapshots have UUIDs as their name property.</p>
<p>I’ve also stripped out David’s error handling, as I find that if there’s
an error ejecting the disk it’s usually communicated by the Finder
itself rather than via an error code visible to AppleScript.</p>
<p>This doesn’t tackle the problem of the Finder refusing to eject a drive
containing opened files, even if those files are opened by (from the
user’s perspective) unimportant background commands. I spent a chunk of
the morning mulling this over (and looking at <code>lsof</code>’s inscrutable man
page!), and think I might try to run the output of <code>lsof -F</code> through AWK
to enable a prompt-to-terminate interface. This is particularly
important for me as I keep my music and photo libraries on an external
drive; the photo library in particular is often opened by background
system tasks, I think as iCloud syncs across new photos from my phone.</p>
</article>
</main>
<footer class=site-footer>
<small class=mute-links>
This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>
Creative Commons Attribution 4.0 International License</a>.
</small>
</footer>
</div>
</body>
</html>