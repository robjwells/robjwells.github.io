<!doctype html><html lang=en><head><title>Primary Unit – Locale in OS X and Launch Agents</title><meta charset=utf-8><link rel=license href=https://creativecommons.org/licenses/by/4.0/><link rel=alternate type=application/rss+xml href=/rss.xml title="Primary Unit"><link rel=alternate type=application/json href=/feed.json title="Primary Unit"><link rel=mask-icon href=/favicon.svg color=#1369bf><link rel=apple-touch-icon-precomposed href=/favicon.png><link rel=icon href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A blog by Rob Wells, mostly about computer stuff."><style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey: #607080;--grey10: #eff0f2;--grey5: #f7f8f9;--blue: #1369bf;--blue10: #e7eff8;--purple: #7436b3;--lineSpace: 1.75rem;--halfLine: calc(var(--lineSpace) / 2);--quarterLine: calc(var(--lineSpace) / 4);--bigGap: calc(var(--lineSpace) * 2);--paragraphWidth: 40rem;--wrapperWidth: 50rem;--huge: 1.75rem;--big: 1.5625rem;--medium: 1.375rem;--text: 1.125rem;--small: 0.875rem;--codeInText: 0.875em;--bodyFonts: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace: 'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article p{max-width:var(--paragraphWidth)}article li{margin-bottom:var(--halfLine);max-width:calc(var(--paragraphWidth) - var(--lineSpace))}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style></head><body><div class=wrapper><header class=site-header><div class="site-title-container mute-links"><h1 class=site-title><a href=/>Primary Unit</a></h1><p class=site-byline><i>by</i> Rob Wells</p></div><nav id=site-nav><ul class="site-links mute-links"><li><a href=/about/>About</a></li><li><a href=/books/>Books I’ve read</a></li><li>Feed:
<a href=/feed.json>JSON</a>,
<a href=/rss.xml>RSS</a></li></ul></nav></header><main><article><header><h2 class=mute-links><a href=/2014/12/locale-in-os-x-and-launch-agents/>Locale in OS X and Launch Agents</a></h2><p><time datetime=2014-12-20T15:46:00+0000>Saturday, December 20 2014</time></p></header><div class=flag><p><strong>Warning: The contents of this post may not be up to date!</strong></p><p>Sorry, but if you’re searching for answers about why you can’t reliably set environment variables in OS X (particularly <code>PATH</code>), the information below may be out of date.</p><p>Apple has changed the system so many times in so many different ways it’s difficult to find <em>anything</em> on the internet about this that is correct and up-to-date, so I’ve placed this warning on the top of every post I’ve written about it.</p><p>As of 2017-03-02 it appears that the best collection of information is <a href=https://github.com/ersiner/osx-env-sync>the osx-env-sync project on GitHub</a> and its associated issues.</p><p>Be wary of anything that you find on StackOverflow: the answers there may well have been correct at the time but incorrect now.</p><p>For reference, my own posts on this problem (newest first) are:</p><ul><li><a href=/2017/03/setting-os-xs-environment/>Setting OS X’s environment</a></li><li><a href=/2014/12/locale-in-os-x-whats-the-current-situation/>Locale in OS X — what’s the current situation?</a></li><li><a href=/2014/12/locale-in-os-x-and-launch-agents/>Locale in OS X and Launch Agents</a></li><li><a href=/2013/09/get-your-us-ascii-out-of-my-face/>Get your US-ASCII out of my face</a></li></ul></div><p>I really dislike <a href=/2013/09/get-your-us-ascii-out-of-my-face/>last year’s post about ASCII and UTF-8</a>. It’s one of those posts that, when you look back, reveals how little you know about a topic. The stuff in there isn’t all wrong but as a whole it’s not correct.</p><p>Towards the end I say that the way to make sure that the locale isn’t <code>C</code> is to export <code>LANG</code> in a bunch of profile/rc files. But that doesn’t work if those files aren’t sourced — quite common when scripts get run on your behalf.</p><p>At some point I got bitten again and fixed it using <a href=http://en.wikipedia.org/wiki/Launchd>launchd</a>. By modifying the /etc/launchd.conf configuration file (as suggested <a href=http://www.digitaledgesw.com/node/31>here</a> and <a href=http://stackoverflow.com/questions/135688/setting-environment-variables-in-os-x/>here</a>), you could make launchd set environment variables at startup:</p><pre><code>bash:
# /etc/launchd.conf
setenv LANG en_GB.UTF-8
</code></pre><p>Dead simple, and ensures that <code>LANG</code> is always correct. But unfortunately useless in Yosemite. From the launchctl man page:</p><blockquote><p>The /etc/launchd.conf file is no longer consulted for subcommands to run during early boot time; this functionality was removed for security considerations.</p></blockquote><p>(I should note that I don’t have a clean install of Yosemite, so maybe Apple has fixed the default locale to something <code>*.UTF-8</code> and my carried-over files have got in the way. But I don’t think so: the guest account defaults to the <code>C</code> locale.)</p><p>There’s a <a href=http://stackoverflow.com/questions/25385934/setting-environment-variables-via-launchd-conf-no-longer-works-in-os-x-yosemite>thread on Stack Overflow</a> containing some discussion about how to handle the change. It’s a bit of a muddle, but the common theme is to use a real launchd job to set environment variables on startup.</p><p>Launchd agents are registered using .plist files (XML), which are a pain to work with by hand, so I recommend <a href=https://www.peterborgapps.com/lingon/>Lingon</a> (nicer to use) or <a href=http://www.soma-zone.com/LaunchControl/>LaunchControl</a> (exposes more settings). The most basic setup is to call launchctl directly:</p><p><img src=/images/2014-12-19_locales-lingon-basic.png alt="Lingon set to run launchctl at startup with the arguments &lsquo;setenv LANG en_GB.UTF-8&rsquo;"></p><p>That’ll save a .plist file in ~/Library/LaunchAgents/ — a job that gets run by launchd when you log in (for your user only). And we’re done!</p><p>Setting the locale in this way means that it will be set correctly for any process that follows (even something like <code>do shell script</code> in AppleScript).</p><h3 id=but-wait>But wait</h3><p>Since we’re mucking around with Launch Agents and using launchctl at boot, we can set up the environment however we like. Rather than use launchctl directly, I run my own script that does several things:</p><pre><code>bash:
 1:  # Launch Agent to set environment variables on boot
 2:  
 3:  set -e
 4:  
 5:  date=$(date +&quot;%Y-%m-%d %H:%M:%S&quot;)
 6:  echo -e &quot;$date\tSetting environment variables with $0&quot;
 7:  
 8:  # Locale
 9:  launchctl setenv LANG en_GB.UTF-8
10:  launchctl setenv LC_ALL en_GB.UTF-8
11:  
12:  # Python
13:  launchctl setenv PYTHONPATH &quot;/Users/robjwells/Dropbox/bin&quot;
14:  
15:  # Path
16:  if [ -x /usr/libexec/path_helper ]; then
17:    export PATH=&quot;&quot;
18:    eval $(/usr/libexec/path_helper -s)
19:    launchctl setenv PATH $PATH
20:  fi
</code></pre><p>It’s largely straightforward: setting the locale correctly, then <code>PYTHONPATH</code> (searched for Python modules), then something more involved for the <code>PATH</code>.</p><p>By default, OS X sets <code>PATH</code> to something that’s pretty sparse:</p><pre><code>/usr/bin:/bin:/usr/sbin:/sbin
</code></pre><p>(You can check this with <code>do shell script "echo $PATH"</code> in AppleScript.)</p><p>That can make some things pretty difficult, particularly if you want to use scripts you’ve written through some kind of intermediary that doesn’t source your setup files.</p><p><a href=https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/path_helper.8.html>path_helper</a> constructs a path from the contents of /etc/paths and files in /etc/paths.d — giving you a much more expansive path than by default (and one you can add to by placing a file of your own in the latter directory). And again, by setting this at boot through launchctl it’s available widely afterwards.</p><p>Not everywhere, though. For instance, <a href=http://smilesoftware.com/TextExpander/index.html>TextExpander</a> <a href=http://www.smilesoftware.com/help/TextExpander/applescript.html>ensures UTF-8 support</a> by setting <code>LANG</code>, but <code>PATH</code> is still restricted to the short one listed above. I get the feeling TextExpander is doing more than just inheriting the environment and tweaking <code>LANG</code>.</p><h3 id=legacy-subcommands>‘Legacy subcommands’</h3><p>The language in the launchctl man page refers to “the previous implementation of launchd” and Yosemite brings with it a new (painful) interface, with the previous interface listed under the heading “legacy subcommands”. Some of the commands listed there don’t have equivalents in the new interface — including the vital <code>setenv</code>.</p><p>I don’t know whether to be worried by the “legacy” description. If these commands go away without similar ones being introduced we could be left without a way to set vital environment variables (fixing Apple’s oversights). But it sounds that launchd has undergone major surgery, so reimplementing the previous interface does suggest some kind of commitment to it, at least in the interim.</p></article></main><footer class=site-footer><small class=mute-links>This work is licensed under a
<a rel=license href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>.</small></footer></div></body></html>