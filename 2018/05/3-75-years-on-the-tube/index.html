<!DOCTYPE html>
<html lang="en">
  <head>
  <title>Primary Unit – 3.75 years on the Tube</title>
  
  
<meta charset="utf-8">

<link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Primary Unit" />
<link rel="alternate" type="application/json" href="/feed.json" title="Primary Unit" />

<link rel="mask-icon" href="/favicon.svg" color="#1369BF">
<link rel="apple-touch-icon-precomposed" href="/favicon.png">
<link rel="icon" href="/favicon.ico">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="A blog by Rob Wells, mostly about computer stuff.">

<style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey: #607080;--grey10: #eff0f2;--grey5: #f7f8f9;--blue: #1369bf;--blue10: #e7eff8;--purple: #7436b3;--lineSpace: 1.75rem;--halfLine: calc(var(--lineSpace) / 2);--quarterLine: calc(var(--lineSpace) / 4);--bigGap: calc(var(--lineSpace) * 2);--paragraphWidth: 40rem;--wrapperWidth: 50rem;--huge: 1.75rem;--big: 1.5625rem;--medium: 1.375rem;--text: 1.125rem;--small: 0.875rem;--codeInText: 0.875em;--bodyFonts: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace: 'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article p{max-width:var(--paragraphWidth)}article li{margin-bottom:var(--halfLine);max-width:calc(var(--paragraphWidth) - var(--lineSpace))}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style>
  
  <style>div.highlight>pre.chroma{padding:0;margin:0}:root{--lineNumberGrey: #6D6D6D;--operatorOrange: #B45000;--stringGreen: #357D06}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .ln{margin-right:var(--halfLine);padding:0;color:var(--lineNumberGrey)}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:var(--operatorOrange)}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:var(--stringGreen)}.chroma .sa{color:var(--stringGreen)}.chroma .sb{color:var(--stringGreen)}.chroma .sc{color:var(--stringGreen)}.chroma .dl{color:var(--stringGreen)}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:var(--stringGreen)}.chroma .se{color:var(--stringGreen)}.chroma .sh{color:var(--stringGreen)}.chroma .si{color:var(--stringGreen)}.chroma .sx{color:var(--stringGreen)}.chroma .sr{color:var(--stringGreen)}.chroma .s1{color:var(--stringGreen)}.chroma .ss{color:var(--stringGreen)}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:var(--operatorOrange);font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}</style>

</head>

  <body>
    <div class="wrapper">
      
  <header class="site-header">

    <div class="site-title-container mute-links">
      <h1 class="site-title"><a href="/">Primary Unit</a></h1>
      <p class="site-byline"><i>by</i> Rob Wells</p>
    </div>

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/books/">Books I’ve read</a></li>
        <li>
          Feed:
          <a href="/feed.json">JSON</a>,
          <a href="/rss.xml">RSS</a>
        </li>
      </ul>
    </nav>

  </header> 

      <main>
        
    <article>
      <header>
        <h2 class="mute-links"><a href="/2018/05/3-75-years-on-the-tube/">3.75 years on the Tube</a></h2>
        
        <p><time datetime='2018-05-03T01:00:00&#43;0000'>Thursday, May 3 2018</time></p>
        
      </header>
      <p>A couple of years ago, shortly after I moved house, I wrote <a href="/2016/09/two-years-on-the-tube/">a post analysing my Tube travel</a>. It was my first real attempt to do that kind of analysis, and the first time I’d done anything with <a href="https://matplotlib.org">Matplotlib</a> of any level of complexity.</p>
<p>I thought I’d have another crack at it now, looking at the changes in my travel patterns since the move, and also changing from Python and Matplotlib to R and ggplot2.</p>
<p>Why now? There’s no great immediate reason, though for a time I was thinking about stopping to use my Oyster card in favour of a contactless bank card. You don’t have the option to be emailed CSV journey history files with a bank card, and the main advantage of weekly capping wouldn’t affect me, so I’ll be sticking with the Oyster card for the moment.</p>
<p>But, as I noted in the introduction to the previous post, my travel habits have changed considerably. Before I would commute by train twice a day, whereas now I’m within a short cycle of work. I’m expecting this to have a significant effect in what we observe below.</p>
<p>And why the switch in environment? Python is still the language that fits my brain the best, but Matplotlib feels like hard work. R is a pretty odd language in many ways, but the ggplot2 way of building plots makes a great deal of sense to me, and has allowed me to play with plots quickly in ways that I feel that wouldn’t be available if I was trying to contort to fit Matplotlib’s preferences. I freely admit that I don’t have a great deal of experience with Matplotlib, so it’s entirely possible that’s the reason why I find it a struggle, but that barrier just isn’t there with ggplot2.</p>
<p>I’m writing this post in <a href="https://www.rstudio.com/products/RStudio/">RStudio</a> in a <a href="https://rmarkdown.rstudio.com">R Markdown</a> document, but it’s actually my second go at this. The first was invaluable in getting myself acquainted with the process and playing around with ideas, but it kind of spiralled out of control so it’s not presentable. Hopefully this is something approaching readable.</p>
<h3 id="setup">Setup</h3>
<p>To start with we’re going to load some libraries to make our life easier. The <a href="https://www.tidyverse.org">Tidyverse</a> wraps up several helpful packages; lubridate has some handy date-handling functions; stringr is helpful for, er, strings; patchwork allows you to easily combine plots into one figure; ggalt provides an extra geom (<code>geom_encircle()</code>) that we’ll use in a bit. Forgive me for not making clear where functions come from below as, like Swift, R imports into the global namespace.</p>
<p>Not shown is my customised ggplot2 theme, which you can find if you <a href="https://github.com/robjwells/primaryunit/tree/master/posts/2018/04">look at the original .Rmd source file</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">patchwork</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggalt</span><span class="p">)</span>

<span class="c1"># Moving average function from https://stackoverflow.com/a/4862334/1845155</span>
<span class="n">mav</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">stats</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">sides</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="data-import">Data import</h3>
<p>I keep all the CSV files as received, just dating the filenames with the date I got them. (Sorry, I won’t be sharing the data.) Let’s load all the files:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">oyster_filenames</span> <span class="o">&lt;-</span> <span class="nf">dir</span><span class="p">(</span>
    <span class="s">&#39;~/Documents/Oyster card/Journey history CSVs/&#39;</span><span class="p">,</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;*.csv&#39;</span><span class="p">,</span>
    <span class="n">full.names</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre></div><p>There are 109 CSV files that we need to open, load, and combine.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">oyster_data</span> <span class="o">&lt;-</span> <span class="n">oyster_filenames</span> <span class="o">%&gt;%</span>
    <span class="nf">map</span><span class="p">(</span><span class="o">~</span> <span class="nf">read_csv</span><span class="p">(</span><span class="n">.,</span> <span class="n">skip</span> <span class="o">=</span> <span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">reduce</span><span class="p">(</span><span class="n">rbind</span><span class="p">)</span>
</code></pre></div><p>Here we’re piping <code>oyster_filenames</code> through <code>map</code>, where we use an R formula to supply arguments to <code>read_csv</code> to skip the header line in each file. Finally we <code>reduce</code> the 109 data frames by binding them by row.</p>
<h3 id="poking-around-the-data">Poking around the data</h3>
<p>We can take a look at the data to get an idea of its structure:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">head</span><span class="p">(</span><span class="n">oyster_data</span><span class="p">)</span>
</code></pre></div><pre><code>## # A tibble: 6 x 8
##   Date   `Start Time` `End Time` `Journey/Action`    Charge Credit Balance
##   &lt;chr&gt;  &lt;time&gt;       &lt;time&gt;     &lt;chr&gt;                &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1 31-Oc… 23:22        23:50      North Greenwich to…    1.5 &lt;NA&gt;     26.0
## 2 31-Oc… 18:39        18:59      Woolwich Arsenal D…    1.6 &lt;NA&gt;     27.6
## 3 31-Oc… 18:39           NA      Auto top-up, Woolw…   NA   20       29.2
## 4 31-Oc… 17:10        17:37      Stratford to Woolw…    1.6 &lt;NA&gt;      9.15
## 5 31-Oc… 16:26        16:53      Woolwich Arsenal D…    1.6 &lt;NA&gt;     10.8
## 6 30-Oc… 22:03        22:39      Pudding Mill Lane …    1.5 &lt;NA&gt;     12.4
## # ... with 1 more variable: Note &lt;chr&gt;
</code></pre><p>It’s clearly in need of a clean-up. The journey history file appears to be a record of every action involving the card. It’s interesting to note that the Oyster card isn’t just a “key” to pass through the ticket barriers, but a core part of how the account is managed (note that having an online account is entirely optional).</p>
<p>Actions taken “outside” of the card need to be “picked up” by the card by tapping on an Oyster card reader. Here we can see a balance increase being collected, mixed in with the journey details. (Funnily enough, TfL accidentally cancelled my automatic top-up a couple of months ago, but that was never applied to my account as I didn’t use the card before the action expired.)</p>
<p>But we’re only interested in rail journeys, one station to another, with a start and finish time.</p>
<p>Let’s see if the notes field can give us any guidance of what we may need to exclude.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">oyster_data</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Note</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">count</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre></div><pre><code>## # A tibble: 5 x 2
##   Note                                                                   n
##   &lt;chr&gt;                                                              &lt;int&gt;
## 1 The fare for this journey was capped as you reached the daily cha…    18
## 2 We are not able to show where you touched out during this journey      6
## 3 This incomplete journey has been updated to show the &lt;station&gt; yo…     1
## 4 We are not able to show where you touched in during this journey       1
## 5 You have not been charged for this journey as it is viewed as a c…     1
</code></pre><p>OK, not much here, but there are some troublesome rail journeys missing either a starting or finishing station. The “incomplete journey” line also hints at something to be aware of:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">oyster_data</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="s">&#39;This incomplete journey&#39;</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">select</span><span class="p">(</span><span class="n">`Journey/Action`</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">first</span><span class="p">()</span>
</code></pre></div><pre><code>## [1] &quot;Woolwich Arsenal DLR to &lt;Blackheath [National Rail]&gt;&quot;
</code></pre><p>Note the angle brackets surrounding the substituted station. We’ll come back to this later.</p>
<p>A missing start or finish time is a giveaway for oddities, which overlaps somewhat but not completely with Journey/Action fields that don’t match the pattern of <code>{station} to {station}</code>. Let’s fish those out and have a look at the abbreviated descriptions:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">stations_regex</span> <span class="o">&lt;-</span> <span class="s">&#39;^&lt;?([^&gt;]+)&gt;? to &lt;?([^&gt;]+)&gt;?$&#39;</span>

<span class="n">oyster_data</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span>
        <span class="nf">is.na</span><span class="p">(</span><span class="n">`Start Time`</span><span class="p">)</span> <span class="o">|</span>
        <span class="nf">is.na</span><span class="p">(</span><span class="n">`End Time`</span><span class="p">)</span> <span class="o">|</span>
        <span class="o">!</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">`Journey/Action`</span><span class="p">,</span> <span class="n">stations_regex</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">mutate</span><span class="p">(</span><span class="n">abbr</span> <span class="o">=</span> <span class="nf">str_extract</span><span class="p">(</span><span class="n">`Journey/Action`</span><span class="p">,</span> <span class="s">&#39;^[^,]+&#39;</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">count</span><span class="p">(</span><span class="n">abbr</span><span class="p">,</span> <span class="n">sort</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre></div><pre><code>## # A tibble: 11 x 2
##    abbr                                              n
##    &lt;chr&gt;                                         &lt;int&gt;
##  1 Auto top-up                                      84
##  2 Bus journey                                      26
##  3 Automated Refund                                  7
##  4 Woolwich Arsenal DLR to [No touch-out]            3
##  5 Oyster helpline refund                            2
##  6 Unknown transaction                               2
##  7 [No touch-in] to Woolwich Arsenal DLR             1
##  8 Entered and exited Woolwich Arsenal DLR           1
##  9 Monument to [No touch-out]                        1
## 10 Stratford International DLR to [No touch-out]     1
## 11 Stratford to [No touch-out]                       1
</code></pre><h3 id="tidying-the-data">Tidying the data</h3>
<p>All these should be filtered out of the data for analysis. (The two unknown transactions appear to be two halves of my old commute. Strange.)</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">rail_journeys</span> <span class="o">&lt;-</span> <span class="n">oyster_data</span> <span class="o">%&gt;%</span>
    <span class="c1"># Note the !() below to invert the earlier filter</span>
    <span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="p">(</span>
        <span class="nf">is.na</span><span class="p">(</span><span class="n">`Start Time`</span><span class="p">)</span> <span class="o">|</span>
        <span class="nf">is.na</span><span class="p">(</span><span class="n">`End Time`</span><span class="p">)</span> <span class="o">|</span>
        <span class="o">!</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">`Journey/Action`</span><span class="p">,</span> <span class="n">stations_regex</span><span class="p">)))</span>
</code></pre></div><p>That leaves us with 993 rail journeys to have a look at.</p>
<p>But there’s more tidying-up to do:</p>
<ul>
<li>Journey dates and times are stored separately. Finish times may be after midnight (and so on the day after the date they’re associated with).</li>
<li>Start and finish stations need to be separated. (And don’t forget that set of angle brackets.)</li>
<li>All money-related fields should be dropped except for “charge” (the journey fare).</li>
</ul>
<p>Let’s have a crack at it, proceeding in that order:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">tidy_journeys</span> <span class="o">&lt;-</span> <span class="n">rail_journeys</span> <span class="o">%&gt;%</span>
    <span class="nf">mutate</span><span class="p">(</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nf">dmy_hms</span><span class="p">(</span>
            <span class="nf">str_c</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">`Start Time`</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">),</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="s">&#39;Europe/London&#39;</span><span class="p">),</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nf">dmy_hms</span><span class="p">(</span>
            <span class="nf">str_c</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">`End Time`</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">),</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="s">&#39;Europe/London&#39;</span><span class="p">)</span> <span class="o">+</span>
            <span class="c1"># Add an extra day if the journey ends “earlier” than the start</span>
            <span class="nf">days</span><span class="p">(</span><span class="m">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">`End Time`</span> <span class="o">&lt;</span> <span class="n">`Start Time`</span><span class="p">)),</span>
        <span class="c1"># Let’s add a duration to make our lives easier</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>

        <span class="n">enter</span> <span class="o">=</span> <span class="nf">str_match</span><span class="p">(</span><span class="n">`Journey/Action`</span><span class="p">,</span> <span class="n">stations_regex</span><span class="p">)</span><span class="n">[</span><span class="p">,</span><span class="m">2</span><span class="n">]</span><span class="p">,</span>
        <span class="n">exit</span> <span class="o">=</span> <span class="nf">str_match</span><span class="p">(</span><span class="n">`Journey/Action`</span><span class="p">,</span> <span class="n">stations_regex</span><span class="p">)</span><span class="n">[</span><span class="p">,</span><span class="m">3</span><span class="n">]</span>
    <span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">select</span><span class="p">(</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
        <span class="n">enter</span><span class="p">,</span> <span class="n">exit</span><span class="p">,</span>
        <span class="n">fare</span> <span class="o">=</span> <span class="n">Charge</span>
    <span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="c1"># Sorting solely to correct the slightly odd example output</span>
    <span class="nf">arrange</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">tidy_journeys</span><span class="p">)</span>
</code></pre></div><pre><code>## # A tibble: 6 x 6
##   start               end                 duration enter    exit      fare
##   &lt;dttm&gt;              &lt;dttm&gt;              &lt;time&gt;   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
## 1 2014-09-06 13:14:00 2014-09-06 13:42:00 28       Woolwic… Stratfo…   1.5
## 2 2014-09-06 13:59:00 2014-09-06 14:08:00 9        Stratfo… Hackney…   1.5
## 3 2014-09-06 20:47:00 2014-09-06 21:02:00 15       Hackney… Highbur…   1.5
## 4 2014-09-06 23:22:00 2014-09-07 00:10:00 48       Highbur… Woolwic…   2.7
## 5 2014-09-07 10:00:00 2014-09-07 10:30:00 30       Woolwic… Pudding…   1.5
## 6 2014-09-07 20:43:00 2014-09-07 21:15:00 32       Pudding… Woolwic…   1.5
</code></pre><p>Great. The duration variable isn’t strictly necessary but it’ll make things a tad clearer later on.</p>
<h3 id="weekly-totals">Weekly totals</h3>
<p>For a start, let’s try to remake the first plot from <a href="/2016/09/two-years-on-the-tube/">my previous post</a>, of weekly spending with a moving average.</p>
<p>Looking back, it’s not tremendously helpful, but it’s a starting point. (In addition, while that plot is labelled as showing a six-week average, the code computes <a href="https://github.com/robjwells/primaryunit/blob/master/posts/2016/09/analyse_journey_history.py#L168">an eight-week average</a>, and a quick count of the points preceding the average line confirms it.)</p>
<p>But there’s a problem with the data: they record journeys made, not the absence of any journeys (obviously). If we’re to accurately plot weekly spending, we need to include weeks where no journeys were made and no money spent.</p>
<p>First, let’s make a data frame containing every <a href="https://en.wikipedia.org/wiki/ISO_week_date">ISO week</a> from the earliest journey in our data to the most recent.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">blank_weeks</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">tidy_journeys</span><span class="o">$</span><span class="n">start</span><span class="p">),</span>
    <span class="nf">max</span><span class="p">(</span><span class="n">tidy_journeys</span><span class="o">$</span><span class="n">end</span><span class="p">),</span>
    <span class="n">by</span> <span class="o">=</span> <span class="s">&#39;1 week&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">tibble</span><span class="p">(</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">.,</span>
        <span class="n">week</span> <span class="o">=</span> <span class="nf">format</span><span class="p">(</span><span class="n">.,</span> <span class="s">&#39;%G-W%V&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">blank_weeks</span><span class="p">)</span>
</code></pre></div><pre><code>## # A tibble: 6 x 2
##   start               week
##   &lt;dttm&gt;              &lt;chr&gt;
## 1 2014-09-06 13:14:00 2014-W36
## 2 2014-09-13 13:14:00 2014-W37
## 3 2014-09-20 13:14:00 2014-W38
## 4 2014-09-27 13:14:00 2014-W39
## 5 2014-10-04 13:14:00 2014-W40
## 6 2014-10-11 13:14:00 2014-W41
</code></pre><p>The format string uses the ISO week year (%G) and the ISO week number (%V), which may differ from what you might intuitively expect. I’ve included a somewhat arbitrary start time, as it’s a bit easier to plot and label datetimes rather than the year-week strings.</p>
<p>Now we need to summarise our actual journey data, collecting the total fare for each ISO week. We’ll use <code>group_by()</code> and <code>summarise()</code> — two tools that took me a few tries to get a handle on. Here <code>summarise()</code> works group-wise based on the result of <code>group_by()</code>; you don’t have to pass the group into the <code>summarise()</code> call, just specify the value you want summarised and how.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">real_week_totals</span> <span class="o">&lt;-</span> <span class="n">tidy_journeys</span> <span class="o">%&gt;%</span>
    <span class="nf">group_by</span><span class="p">(</span><span class="n">week</span> <span class="o">=</span> <span class="nf">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&#39;%G-W%V&#39;</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">summarise</span><span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">fare</span><span class="p">))</span>
</code></pre></div><p>That done, we can use an SQL-like join operation to take every week in our giant list and match it against the week summaries from our real data. The join leaves missing values (<code>NA</code>) in the total column for weeks where no journeys were made (and so weren’t present in the data to summarise) so we replace them with zero.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">complete_week_totals</span> <span class="o">&lt;-</span> <span class="nf">left_join</span><span class="p">(</span><span class="n">blank_weeks</span><span class="p">,</span>
                                  <span class="n">real_week_totals</span><span class="p">,</span>
                                  <span class="n">by</span> <span class="o">=</span> <span class="s">&#39;week&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">replace_na</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">total</span> <span class="o">=</span> <span class="m">0</span><span class="p">))</span>
<span class="nf">tail</span><span class="p">(</span><span class="n">complete_week_totals</span><span class="p">)</span>
</code></pre></div><pre><code>## # A tibble: 6 x 3
##   start               week     total
##   &lt;dttm&gt;              &lt;chr&gt;    &lt;dbl&gt;
## 1 2018-03-17 12:14:00 2018-W11   0
## 2 2018-03-24 12:14:00 2018-W12   0
## 3 2018-03-31 13:14:00 2018-W13  21.1
## 4 2018-04-07 13:14:00 2018-W14   9.5
## 5 2018-04-14 13:14:00 2018-W15   0
## 6 2018-04-21 13:14:00 2018-W16   7.8
</code></pre><p>With this summary frame assembled, we can now plot the totals. I’m also going to mark roughly when I moved house so we can try to see if there’s any particular shift.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">house_move</span> <span class="o">&lt;-</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">&#39;2016-08-01&#39;</span><span class="p">)</span>
<span class="n">pound_scale</span> <span class="o">&lt;-</span> <span class="n">scales</span><span class="o">::</span><span class="nf">dollar_format</span><span class="p">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;£&#39;</span><span class="p">)</span>

<span class="n">weeks_for_avg</span> <span class="o">&lt;-</span> <span class="m">8</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">complete_week_totals</span><span class="p">,</span>
       <span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">total</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_vline</span><span class="p">(</span>
        <span class="n">xintercept</span> <span class="o">=</span> <span class="n">house_move</span><span class="p">,</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="n">rjw_grey</span><span class="p">,</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.75</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_point</span><span class="p">(</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="n">rjw_blue</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="m">0.75</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="nf">mav</span><span class="p">(</span><span class="n">complete_week_totals</span><span class="o">$</span><span class="n">total</span><span class="p">,</span>
                              <span class="n">weeks_for_avg</span><span class="p">)),</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="n">rjw_red</span><span class="p">)</span> <span class="o">+</span>

    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nf">str_glue</span><span class="p">(</span>
            <span class="s">&#39;Weekly transport spending and {weeks_for_avg}&#39;</span><span class="p">,</span>
            <span class="s">&#39;-week moving average&#39;</span><span class="p">),</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;September 2014 to May 2018, vertical bar marks house move&#39;</span><span class="p">),</span>
        <span class="n">x</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="o">+</span>

    <span class="nf">scale_x_datetime</span><span class="p">(</span>
        <span class="n">date_breaks</span> <span class="o">=</span> <span class="s">&#39;6 months&#39;</span><span class="p">,</span>
        <span class="n">date_labels</span> <span class="o">=</span> <span class="s">&#39;%b ’%y&#39;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pound_scale</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-weekly-spending-1.svg"
        alt="A plot showing my weekly Oyster card spending, September 2014 to May 2018"
        class="no-border"
        width=720
        />
</p>
<p>It’s clear that there is a difference after the house move. But I’m not sure this plot is the best way to show it. (Nor the best way to show anything.)</p>
<p>That said, the code for this plot is a pretty great example of what I like about ggplot2: you create a plot, add geoms to it, customise the labels and scales, piece by piece until you’re happy. It’s fairly straightforward to discover things (especially with RStudio’s completion), and you change things by adding on top of the basics instead of hunting around in the properties of figures or axes or whatever.</p>
<h3 id="cumulative-spending">Cumulative spending</h3>
<p>The first plot showed a change in my average weekly spending. What does that look like when we plot the cumulative spending over this period?</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">tidy_journeys</span><span class="p">,</span>
       <span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
                     <span class="n">y</span> <span class="o">=</span> <span class="nf">cumsum</span><span class="p">(</span><span class="n">fare</span><span class="p">),</span>
                     <span class="n">colour</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">house_move</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span>
        <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>

    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Cumulative Oyster card spending&#39;</span><span class="p">,</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="s">&#39;September 2014 to May 2018&#39;</span><span class="p">,</span>
        <span class="n">x</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="s">&#39;House move&#39;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pound_scale</span><span class="p">,</span>
        <span class="n">breaks</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">500</span><span class="p">,</span> <span class="m">1000</span><span class="p">,</span> <span class="m">1400</span><span class="p">,</span> <span class="m">1650</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_color_brewer</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Before&#39;</span><span class="p">,</span> <span class="s">&#39;After&#39;</span><span class="p">),</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="s">&#39;Set2&#39;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span>
        <span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#39;bottom&#39;</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-cumulative-spending-1.svg"
        alt="A plot showing my cumulative Oyster card spending, September 2014 to May 2018"
        class="no-border"
        width=720
        />
</p>
<p>The difference in slope is quite clear; at one point I fitted a linear smoother to the two periods but it overlapped so tightly with the data that it was difficult to read either. I’ve also monkeyed around with the y-axis breaks to highlight the difference; what before took three to six months to spend has taken about 21 months since the house move.</p>
<h3 id="zero-spending-weeks">Zero-spending weeks</h3>
<p>One thing that shows up in the first plot, and likely underlies the drop in average spending, is the number of weeks where I don’t travel using my Oyster card at all. Let’s pull together a one-dimensional plot showing just that.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">ggplot</span><span class="p">(</span><span class="n">complete_week_totals</span><span class="p">,</span>
       <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
           <span class="n">y</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
           <span class="n">fill</span> <span class="o">=</span> <span class="n">total</span> <span class="o">==</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_col</span><span class="p">(</span>
        <span class="n">width</span> <span class="o">=</span> <span class="m">60</span> <span class="o">*</span> <span class="m">60</span> <span class="o">*</span> <span class="m">24</span> <span class="o">*</span> <span class="m">7</span><span class="p">)</span> <span class="o">+</span>  <span class="c1"># datetime col width handled as seconds</span>
    <span class="nf">geom_vline</span><span class="p">(</span>
        <span class="n">xintercept</span> <span class="o">=</span> <span class="n">house_move</span><span class="p">,</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="n">rjw_red</span><span class="p">)</span> <span class="o">+</span>

    <span class="nf">scale_fill_manual</span><span class="p">(</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="nf">str_c</span><span class="p">(</span><span class="n">rjw_grey</span><span class="p">,</span> <span class="s">&#39;20&#39;</span><span class="p">),</span> <span class="n">rjw_grey</span><span class="p">),</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Some&#39;</span><span class="p">,</span> <span class="s">&#39;None&#39;</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_x_datetime</span><span class="p">(</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">complete_week_totals</span><span class="o">$</span><span class="n">start</span><span class="p">),</span>
                   <span class="nf">max</span><span class="p">(</span><span class="n">complete_week_totals</span><span class="o">$</span><span class="n">start</span><span class="p">)),</span>
        <span class="n">expand</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span>
        <span class="n">breaks</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Weeks with zero Oyster card spending&#39;</span><span class="p">,</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="s">&#39;September 2014 to May 2018, red line marks house move&#39;</span><span class="p">,</span>
        <span class="n">x</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="s">&#39;Spending&#39;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span>
        <span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#39;bottom&#39;</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-zero-spending-weeks-1.svg"
        alt="A plot showing weeks where I made no journeys using my Oyster card"
        class="no-border"
        width=720
        />
</p>
<p>The change here after I moved house is stark, nearly an inversion of the previous pattern of zero/no-zero spending weeks. (Almost looks like <a href="https://www.robjwells.com/2018/02/british-newspaper-barcodes-explained-and-automated/">a barcode</a>!)</p>
<p>My apologies for the thin lines between columns, which is an SVG artefact. The inspiration for this was <a href="https://www.macstories.net/stories/exploring-the-app-stores-top-grossing-chart/">a plot of games/non-games in the App Store top charts</a> that Dr Drang included <a href="http://www.leancrew.com/all-this/2016/07/a-delightfully-simple-chart/">at the bottom of one of his posts</a>.</p>
<h3 id="changes-in-journey-properties">Changes in journey properties</h3>
<p>So it’s clear that I travel less on the Tube network, and that I spend less. But what has happened to the sort of journeys that I make? Are they longer? Shorter? Less expensive? More?</p>
<p>Let’s have a look at how the average fare and average journey duration change over time.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">n_journey_avg</span> <span class="o">&lt;-</span> <span class="m">10</span>

<span class="n">common_vline</span> <span class="o">&lt;-</span> <span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="n">house_move</span><span class="p">,</span>
                           <span class="n">colour</span> <span class="o">=</span> <span class="n">rjw_red</span><span class="p">)</span>
<span class="n">common_point</span> <span class="o">&lt;-</span> <span class="nf">geom_point</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">.5</span><span class="p">)</span>

<span class="n">fares_over_time</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">tidy_journeys</span><span class="p">,</span>
                          <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
                              <span class="n">y</span> <span class="o">=</span> <span class="nf">mav</span><span class="p">(</span><span class="n">fare</span><span class="p">,</span> <span class="n">n_journey_avg</span><span class="p">)))</span> <span class="o">+</span>
    <span class="nf">scale_x_datetime</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pound_scale</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">y</span> <span class="o">=</span> <span class="s">&#39;Fare&#39;</span><span class="p">,</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;More expensive, shorter journeys&#39;</span><span class="p">,</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="nf">str_glue</span><span class="p">(</span><span class="s">&#39;{n_journey_avg}-journey average, &#39;</span><span class="p">,</span>
                            <span class="s">&#39;vertical line marks house move&#39;</span><span class="p">))</span>

<span class="n">duration_over_time</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">tidy_journeys</span><span class="p">,</span>
                             <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span>
                                 <span class="n">y</span> <span class="o">=</span> <span class="nf">mav</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">n_journey_avg</span><span class="p">)))</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">y</span> <span class="o">=</span> <span class="s">&#39;Duration (mins)&#39;</span><span class="p">)</span>

<span class="p">(</span><span class="n">fares_over_time</span> <span class="o">/</span> <span class="n">duration_over_time</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># Patchwork is magic</span>
    <span class="n">common_vline</span> <span class="o">&amp;</span>
    <span class="n">common_point</span> <span class="o">&amp;</span>
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-fare-duration-averages-1.svg"
        alt="A plot of average fares and journey durations over time"
        class="no-border"
        width=720
        />
</p>
<p>Journeys taken after the house move appear to be shorter and more expensive. How distinct is this? What is driving the averages? I have a hunch so let me rush on ahead with this plot.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">commute_stations</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Woolwich Arsenal DLR&#39;</span><span class="p">,</span> <span class="s">&#39;Stratford International DLR&#39;</span><span class="p">,</span>
                      <span class="s">&#39;Stratford&#39;</span><span class="p">,</span> <span class="s">&#39;Pudding Mill Lane DLR&#39;</span><span class="p">)</span>

<span class="n">commute_journeys</span> <span class="o">&lt;-</span> <span class="n">tidy_journeys</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span>
        <span class="n">enter</span> <span class="o">%in%</span> <span class="n">commute_stations</span><span class="p">,</span>
        <span class="n">exit</span> <span class="o">%in%</span> <span class="n">commute_stations</span><span class="p">)</span>

<span class="n">high_speed_journeys</span> <span class="o">&lt;-</span> <span class="n">tidy_journeys</span> <span class="o">%&gt;%</span>
    <span class="nf">filter</span><span class="p">(</span>
        <span class="nf">str_detect</span><span class="p">(</span><span class="n">enter</span><span class="p">,</span> <span class="s">&#39;HS1&#39;</span><span class="p">),</span>
        <span class="nf">str_detect</span><span class="p">(</span><span class="n">exit</span><span class="p">,</span> <span class="s">&#39;HS1&#39;</span><span class="p">))</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">tidy_journeys</span><span class="p">,</span>
       <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">fare</span><span class="p">,</span>
           <span class="n">y</span> <span class="o">=</span> <span class="n">duration</span><span class="p">,</span>
           <span class="n">colour</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">house_move</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_jitter</span><span class="p">(</span>
        <span class="n">width</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">,</span>  <span class="c1"># 5p</span>
        <span class="n">height</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span>  <span class="c1"># 30 seconds</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_encircle</span><span class="p">(</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">commute_journeys</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="m">1.5</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_encircle</span><span class="p">(</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">high_speed_journeys</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="m">1.5</span><span class="p">)</span> <span class="o">+</span>

    <span class="nf">scale_color_brewer</span><span class="p">(</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="s">&#39;Set2&#39;</span><span class="p">,</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Before&#39;</span><span class="p">,</span> <span class="s">&#39;After&#39;</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_x_continuous</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pound_scale</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">80</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Pre- and post-move averages driven by two groups&#39;</span><span class="p">,</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="nf">str_c</span><span class="p">(</span><span class="s">&#39;Old commute and high-speed journeys circled,&#39;</span><span class="p">,</span>
                         <span class="s">&#39; positions not exact&#39;</span><span class="p">),</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s">&#39;Fare&#39;</span><span class="p">,</span>
        <span class="n">y</span> <span class="o">=</span> <span class="s">&#39;Duration (mins)&#39;</span><span class="p">,</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="s">&#39;House move&#39;</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-fare-duration-scatter-1.svg"
        alt="A plot of journey fare against distance, grouped by whether the journeys were before or after I moved house"
        class="no-border"
        width=720
        />
</p>
<p>We can see in the lower central section that there’s some overlap. Remember also that there are far fewer post-move journeys, so it’s not surprising that earlier ones dominate this plot. (I added jitter to the points to make things a little easier to see — <code>geom_jitter()</code> is a wrapper around <code>geom_point()</code>.)</p>
<p>But what is crucial to understanding the averages are the two rough groups circled: journeys between stations that I used for my old commute (on the left in green), and journeys involving travel on the <a href="https://en.wikipedia.org/wiki/High_Speed_1">High Speed 1</a> (HS1) rail line (on the right in orange).</p>
<p>My old commute was low-cost, each way either £1.50 or £1 (with an off-peak railcard discount, applied for part of the pre-move period). There are a lot of these journeys (nearly 500). It was a fairly predictable 30ish-minute journey.</p>
<p>On the other hand, trips involving the HS1 line are expensive and very short. A single off-peak fare is currently £3.90 and peak £5.60, while the journey time between Stratford International and St Pancras is just seven minutes, with a bit of waiting inside the gateline.</p>
<h3 id="but-is-that-it">But is that it?</h3>
<p>Does that theory of the two extreme groups really explain the difference? Let’s filter out the two groups from our journey data.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">journeys_without_extremes</span> <span class="o">&lt;-</span> <span class="n">tidy_journeys</span> <span class="o">%&gt;%</span>
    <span class="nf">anti_join</span><span class="p">(</span><span class="n">commute_journeys</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">anti_join</span><span class="p">(</span><span class="n">high_speed_journeys</span><span class="p">)</span>
</code></pre></div><p>Let’s look how the journey durations compare:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">ggplot</span><span class="p">(</span><span class="n">journeys_without_extremes</span><span class="p">,</span>
       <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">duration</span><span class="p">,</span>
           <span class="n">fill</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">house_move</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_histogram</span><span class="p">(</span>
        <span class="n">binwidth</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="s">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="m">0.15</span><span class="p">,</span>
        <span class="n">position</span> <span class="o">=</span> <span class="s">&#39;identity&#39;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_x_continuous</span><span class="p">(</span>
        <span class="n">breaks</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">70</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">70</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_fill_brewer</span><span class="p">(</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="s">&#39;Set2&#39;</span><span class="p">,</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Before&#39;</span><span class="p">,</span> <span class="s">&#39;After&#39;</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Post-move journeys still shorter&#39;</span><span class="p">,</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="s">&#39;Commute and HS1 journeys excluded, bars overlap&#39;</span><span class="p">,</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s">&#39;Duration (mins)&#39;</span><span class="p">,</span>
        <span class="n">y</span> <span class="o">=</span> <span class="s">&#39;Number of journeys&#39;</span><span class="p">,</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="s">&#39;House move&#39;</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-duration-hist-without-extremes-1.svg"
        alt="A histogram showing journey durations having excluded known extremes, with post-move journeys generally shorter"
        class="no-border"
        width=720
        />
</p>
<p>And the fares:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">ggplot</span><span class="p">(</span><span class="n">journeys_without_extremes</span><span class="p">,</span>
       <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">fare</span><span class="p">,</span>
           <span class="n">fill</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">house_move</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_histogram</span><span class="p">(</span>
        <span class="n">binwidth</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="s">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="m">0.15</span><span class="p">,</span>
        <span class="n">position</span> <span class="o">=</span> <span class="s">&#39;identity&#39;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_x_continuous</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pound_scale</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_fill_brewer</span><span class="p">(</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="s">&#39;Set2&#39;</span><span class="p">,</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Before&#39;</span><span class="p">,</span> <span class="s">&#39;After&#39;</span><span class="p">))</span> <span class="o">+</span>

    <span class="nf">labs</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Post-move journeys generally more expensive&#39;</span><span class="p">,</span>
        <span class="n">subtitle</span> <span class="o">=</span> <span class="s">&#39;Commute and HS1 journeys excluded, bars overlap&#39;</span><span class="p">,</span>
        <span class="n">x</span> <span class="o">=</span> <span class="s">&#39;Fare&#39;</span><span class="p">,</span>
        <span class="n">y</span> <span class="o">=</span> <span class="s">&#39;Number of journeys&#39;</span><span class="p">,</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="s">&#39;House move&#39;</span><span class="p">)</span>
</code></pre></div><p class="full-width">
    <img
        src="/images/2018-05-03-fare-hist-without-extremes-1.svg"
        alt="A histogram showing journey fares having excluded known extremes, with post-move fares generally more expensive"
        class="no-border"
        width=720
        />
</p>
<p>While it’s much clearer for duration than cost now, post-move journeys are still generally shorter and more expensive.</p>
<p>At this point, I’ve reached the limits of how far I’m able to take this with visualisation. One possible route would be to look at the distance between station (in miles), how many stations used are in which fare zone, and the number of fare zones crossed. I don’t have stations/fare zones data readily to hand so we’ll leave that here.</p>
<p>But I’ll end with an intuitive answer. Durations are shorter because from Woolwich it takes additional time to get into the main Tube network from the DLR, and particularly to central stations. Whereas now I’m not far from a Central Line station, which will get me into zone 1 fairly quickly.</p>
<p>Fares are higher because I’ve transferred classes of journeys to cycling — not just my commute to work but shopping and leisure. I’d reckon that the remaining journeys are more likely to involve travel into and within central London, and maybe more likely to be at peak times.</p>
<h3 id="last-thoughts">Last thoughts</h3>
<p>If you made it this far, well done, and thanks for reading. There’s a lot of R code in this post, probably too much. But there are two reasons for that: as a reference for myself, and to show that there’s not any magic going on behind the curtain, and very little hard work. (In my code at least, there’s plenty of both in the libraries!)</p>
<p>Working in R with ggplot2 and the other packages really is a pleasure; it doesn’t take very long to grasp how the different tools fit together into nice, composable pieces, and to assemble them in ways that produce something that matches what you have pictured in your mind.</p>

    </article>
    

      </main>
      <footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> 

    </div> 
  </body>
</html>
