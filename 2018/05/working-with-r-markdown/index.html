<!DOCTYPE html>
<html lang="en">
  <head>
  <title>Primary Unit – Working with R Markdown</title>
  
  
<meta charset="utf-8">

<link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Primary Unit" />
<link rel="alternate" type="application/json" href="/feed.json" title="Primary Unit" />

<link rel="mask-icon" href="/favicon.svg" color="#1369BF">
<link rel="apple-touch-icon-precomposed" href="/favicon.png">
<link rel="icon" href="/favicon.ico">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="A blog by Rob Wells, mostly about computer stuff.">

<style>html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,address,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strong,sub,sup,var,b,u,i,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,menu,nav,output,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}input,button{font-family:inherit}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}html{box-sizing:border-box;text-size-adjust:100%}*,*:before,*:after{box-sizing:inherit}:root{--grey: #607080;--grey10: #eff0f2;--grey5: #f7f8f9;--blue: #1369bf;--blue10: #e7eff8;--purple: #7436b3;--lineSpace: 1.75rem;--halfLine: calc(var(--lineSpace) / 2);--quarterLine: calc(var(--lineSpace) / 4);--bigGap: calc(var(--lineSpace) * 2);--paragraphWidth: 40rem;--wrapperWidth: 50rem;--huge: 1.75rem;--big: 1.5625rem;--medium: 1.375rem;--text: 1.125rem;--small: 0.875rem;--codeInText: 0.875em;--bodyFonts: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Oxygen", Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Helvetica, sans-serif;--monospace: 'Source Code Pro', 'Consolas', 'Menlo', 'Monaco', monospace}body{background-color:var(--grey5);font-family:var(--bodyFonts);font-size:var(--text);font-style:normal;font-weight:400;line-height:1.55555;text-size-adjust:100%;-webkit-text-size-adjust:100%}.wrapper{margin:0 auto;max-width:var(--wrapperWidth);padding:var(--lineSpace)var(--halfLine)}h2,h3,h4{margin:0 0 var(--lineSpace)}h2{font-size:var(--huge)}h3{font-size:var(--big)}h4{font-size:var(--medium)}blockquote,figure,p,pre,table,caption,dl,ol,ul,div.highlight{margin-bottom:var(--lineSpace)}blockquote,pre,div.highlight{background-color:var(--grey10);padding:var(--halfLine)}blockquote{font-style:italic}blockquote em,blockquote i{font-style:normal}blockquote p:last-child{margin-bottom:0}figcaption{font-style:italic}hr{border:none;border-top:1px solid var(--grey);margin:var(--lineSpace)0}img,video{box-sizing:content-box;border:1px solid var(--grey);height:auto;max-width:100%}pre{overflow-x:auto}dl,ol,ul{margin-bottom:var(--lineSpace)}ol,ul{list-style-position:outside;padding-left:var(--lineSpace)}ol{list-style-type:decimal}ul{list-style-type:square}a:link{color:var(--blue);text-decoration:underline}a:visited{color:var(--purple)}a:focus,a:hover,a:active{background-color:var(--blue10)}strong,b{font-weight:700}em,i{font-style:italic}code{font-size:var(--codeInText)}.highlight,pre code,small{font-size:var(--small)}.highlight,code{font-family:var(--monospace)}small{color:var(--grey)}table{width:100%}.table-container{overflow-x:auto}caption{font-style:italic}thead{border-bottom:1px solid var(--grey)}tfoot{border-top:1px solid var(--grey)}th,td{width:auto;padding:var(--halfLine);overflow:auto;text-align:left}th{background-color:var(--grey10);font-weight:700}.table-figures{text-align:right;font-family:var(--monospace)}.site-header{border-left:var(--quarterLine)solid var(--blue);display:flex;flex-wrap:wrap;margin-bottom:var(--lineSpace);padding-left:var(--quarterLine)}.site-title-container{flex-shrink:0;margin-right:var(--lineSpace);max-width:100%}.site-title{font-size:var(--huge);line-height:var(--huge);margin-bottom:0}.site-byline{margin-bottom:0}.site-links{color:var(--grey);list-style-type:none;margin-bottom:0;padding:0}.site-footer{margin-top:var(--bigGap)}article{border-bottom:1px solid var(--grey);margin-bottom:var(--bigGap)}article:last-of-type{border-bottom:none}article header{margin-bottom:var(--lineSpace)}article header h2{margin-bottom:0}article header time{color:var(--grey)}article p{max-width:var(--paragraphWidth)}article li{margin-bottom:var(--halfLine);max-width:calc(var(--paragraphWidth) - var(--lineSpace))}.index-date{color:var(--grey);font-family:var(--monospace);font-size:var(--small);min-width:6rem;margin-right:var(--halfLine)}.index-item{margin-bottom:var(--halfLine)}.index-link{align-items:baseline;display:flex}.index-list{padding-left:0;list-style-type:none}.flag{background-color:var(--blue10);border-left:var(--quarterLine)solid var(--blue);margin-bottom:var(--lineSpace);padding:var(--halfLine)var(--quarterLine)}.flag :last-child{margin-bottom:0}.full-width{max-width:100%}.mute-links a{text-decoration:none;color:inherit}.no-border{border:0}.no-border img{border:0}.no-squish{overflow:auto}.no-squish img{max-width:none}@media screen and (min-width:40rem){.pull-left{float:left;clear:left;margin-right:var(--halfLine)}.pull-right{float:right;clear:right;margin-left:var(--halfLine)}.pull-left img,.pull-right img{display:block;margin-bottom:var(--lineSpace)}}</style>
  
  <style>div.highlight>pre.chroma{padding:0;margin:0}:root{--lineNumberGrey: #6D6D6D;--operatorOrange: #B45000;--stringGreen: #357D06}.chroma .x{color:#000}.chroma .err{color:#a40000}.chroma .ln{margin-right:var(--halfLine);padding:0;color:var(--lineNumberGrey)}.chroma .k{color:#204a87;font-weight:700}.chroma .kc{color:#204a87;font-weight:700}.chroma .kd{color:#204a87;font-weight:700}.chroma .kn{color:#204a87;font-weight:700}.chroma .kp{color:#204a87;font-weight:700}.chroma .kr{color:#204a87;font-weight:700}.chroma .kt{color:#204a87;font-weight:700}.chroma .n{color:#000}.chroma .na{color:#c4a000}.chroma .nb{color:#204a87}.chroma .bp{color:#3465a4}.chroma .nc{color:#000}.chroma .no{color:#000}.chroma .nd{color:#5c35cc;font-weight:700}.chroma .ni{color:var(--operatorOrange)}.chroma .ne{color:#c00;font-weight:700}.chroma .nf{color:#000}.chroma .fm{color:#000}.chroma .nl{color:#f57900}.chroma .nn{color:#000}.chroma .nx{color:#000}.chroma .py{color:#000}.chroma .nt{color:#204a87;font-weight:700}.chroma .nv{color:#000}.chroma .vc{color:#000}.chroma .vg{color:#000}.chroma .vi{color:#000}.chroma .vm{color:#000}.chroma .l{color:#000}.chroma .ld{color:#000}.chroma .s{color:var(--stringGreen)}.chroma .sa{color:var(--stringGreen)}.chroma .sb{color:var(--stringGreen)}.chroma .sc{color:var(--stringGreen)}.chroma .dl{color:var(--stringGreen)}.chroma .sd{color:#8f5902;font-style:italic}.chroma .s2{color:var(--stringGreen)}.chroma .se{color:var(--stringGreen)}.chroma .sh{color:var(--stringGreen)}.chroma .si{color:var(--stringGreen)}.chroma .sx{color:var(--stringGreen)}.chroma .sr{color:var(--stringGreen)}.chroma .s1{color:var(--stringGreen)}.chroma .ss{color:var(--stringGreen)}.chroma .m{color:#0000cf;font-weight:700}.chroma .mb{color:#0000cf;font-weight:700}.chroma .mf{color:#0000cf;font-weight:700}.chroma .mh{color:#0000cf;font-weight:700}.chroma .mi{color:#0000cf;font-weight:700}.chroma .il{color:#0000cf;font-weight:700}.chroma .mo{color:#0000cf;font-weight:700}.chroma .o{color:var(--operatorOrange);font-weight:700}.chroma .ow{color:#204a87;font-weight:700}.chroma .p{color:#000;font-weight:700}.chroma .c{color:#8f5902;font-style:italic}.chroma .ch{color:#8f5902;font-style:italic}.chroma .cm{color:#8f5902;font-style:italic}.chroma .c1{color:#8f5902;font-style:italic}.chroma .cs{color:#8f5902;font-style:italic}.chroma .cp{color:#8f5902;font-style:italic}.chroma .cpf{color:#8f5902;font-style:italic}.chroma .g{color:#000}.chroma .gd{color:#a40000}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#ef2929}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#000;font-style:italic}.chroma .gp{color:#8f5902}.chroma .gs{color:#000;font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#a40000;font-weight:700}.chroma .gl{color:#000;text-decoration:underline}.chroma .w{color:#f8f8f8;text-decoration:underline}</style>

</head>

  <body>
    <div class="wrapper">
      
  <header class="site-header">

    <div class="site-title-container mute-links">
      <h1 class="site-title"><a href="/">Primary Unit</a></h1>
      <p class="site-byline"><i>by</i> Rob Wells</p>
    </div>

    <nav id="site-nav">
      <ul class="site-links mute-links">
        <li><a href="/about/">About</a></li>
        <li><a href="/books/">Books I’ve read</a></li>
        <li>
          Feed:
          <a href="/feed.json">JSON</a>,
          <a href="/rss.xml">RSS</a>
        </li>
      </ul>
    </nav>

  </header> 

      <main>
        
    <article>
      <header>
        <h2 class="mute-links"><a href="/2018/05/working-with-r-markdown/">Working with R Markdown</a></h2>
        
        <p><time datetime='2018-05-05T23:55:00&#43;0000'>Saturday, May 5 2018</time></p>
        
      </header>
      <p>I’ve just published an update to <a href="https://www.robjwells.com/2018/05/3-75-years-on-the-tube/">my recent Tube travel post</a>, fixing a few small mistakes, a bigger one (an error in a station name that nonetheless didn’t affect the plot involved) and adding an update to the last section which goes a bit deeper into the fare and duration difference between the two periods.</p>
<p>I didn’t fix the mistake in the title, as I felt it was too late, but of course it’s 3⅔ years, not 3.75, since September 2014.</p>
<p>
    <video src="/images/2018-05-05-naked-gun-realise-that-now.mp4"
        poster="/images/2018-05-05-naked-gun-realise-that-now.jpg"
        controls
        muted>
        <img
        src="/images/2018-05-05-naked-gun-realise-that-now.jpg"
        alt="“I realise that, now…” from the film Naked Gun">
    </video>
</p>
<p>In that post I mentioned how pleasant it is working in <a href="https://www.rstudio.com/products/RStudio/">R Studio</a> in a <a href="https://rmarkdown.rstudio.com">R Markdown</a> document. It really is, and I find the R Markdown way of mixing prose and code much more natural and fluid than <a href="https://jupyter.org">Jupyter notebooks</a>, which I like the idea of but find the block-based method a bit awkward.</p>
<p>The biggest problem with R Markdown was fitting it into my, admittedly arcane, <a href="https://github.com/robjwells/majestic">blogging system</a>. To do so, I’ve cooked up <a href="https://github.com/robjwells/primaryunit/blob/3be7c91007f10946e60fecb3c2007f85080d3950/posts/2018/04/decode_blocks.py">a short Python script</a> to transform the Markdown output from R Studio and <a href="https://yihui.name/knitr/">knitr</a>.</p>
<p>Right now, I’ve settled on this set of output options in the YAML front-matter:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">md_document</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">variant</span><span class="p">:</span><span class="w"> </span><span class="l">markdown_strict+fenced_code_blocks</span><span class="w">
</span><span class="w">    </span><span class="nt">preserve_yaml</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">fig_width</span><span class="p">:</span><span class="w"> </span><span class="m">7.5</span><span class="w">
</span><span class="w">    </span><span class="nt">fig_height</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span><span class="nt">dev</span><span class="p">:</span><span class="w"> </span><span class="l">svg</span><span class="w">
</span><span class="w">    </span><span class="nt">pandoc_args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="w">        </span><span class="s2">&#34;--wrap&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;preserve&#34;</span><span class="w">
</span><span class="w">    </span><span class="p">]</span><span class="w">
</span></code></pre></div><p>Now I don’t actually use fenced (<code>~~~~</code>) code blocks in Markdown, instead I just use regular Markdown indented code blocks with a header line (<code>python:</code>) at the top. But I include that extension in the Markdown variant to make it easier to transform code blocks later.</p>
<p>But why? Well, if your output just uses indented code blocks, it’s difficult to tell which of those are your R code and which are the R code’s output. Fencing the blocks makes it easier to insert empty comments after each block, keeping code and output separate.</p>
<p>The <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> front matter is preserved as I use a similar thing in my own posts and this gets passed through to my blogging system without a problem, with unknown settings ignored. (I do remove the quoting that the template file includes around strings.)</p>
<p>The other important option above is supplying the <code>--wrap</code> argument to <a href="http://pandoc.org">Pandoc</a>, preserving the line breaks as they are in the source file instead of breaking them. By default Pandoc hard-wraps the lines, which I’d be fine with, except that it hard wraps the alt text for images (plots).</p>
<p>That makes it more difficult to pick out later. This is necessary as I always use HTML to include images in my posts (so I can set classes, allow for full-width etc).</p>
<p>I say more difficult as I’m working line-wise. It’d be possible to apply a regex to the joined lines and make the transformation, but then again I don’t hard-wrap my own posts so it’s not something I care about keeping.</p>
<p>The option I would like to use is to keep my Markdown reference links intact, instead of having Pandoc put everything inline. But this makes the images into reference links, making rewriting more difficult again.</p>
<p>So, I knit the document together from R Studio, then apply <a href="https://github.com/robjwells/primaryunit/blob/3be7c91007f10946e60fecb3c2007f85080d3950/posts/2018/04/decode_blocks.py">the script</a>, and pipe the output into the for-real .md file. This is the one that gets checked into the <a href="https://www.mercurial-scm.org">Mercurial</a> repository, fed into my blog generator and ultimately published.</p>
<p>I could probably get away with doing less, or handling things differently — such as allowing for fenced code on the generator’s side.</p>
<p>But I want the transformed output to resemble as closely as possible something that I’d written in <a href="https://www.barebones.com/products/bbedit/">BBEdit</a> because I actually attach some importance to the contents of the Markdown files outside their use as raw material with which to create HTML.</p>
<p>They should be able to tell the post’s story without needing to be processed further, to interpret R code or make the raw source readable. I’m not quite at the point of having totally pure, completely readable plain text files (note those dummy comments mentioned above) but I want to be as close as I can.</p>

    </article>
    

      </main>
      <footer class="site-footer">
  <small class="mute-links">
    This work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License</a>.
  </small>
</footer> 

    </div> 
  </body>
</html>
